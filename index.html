<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-g">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Calculator</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
:root{--wa-header-bg:#53051D;--wa-accent-blue:#34B7F1;--wa-message-out-bg:#e1f6fb;--wa-message-in-bg:#ffffff;--wa-app-bg:#FFF2C3;--wa-chat-bg:#e5ddd5;--wa-icon-color:#f0f2f5;--wa-text-primary:#111b21;--wa-text-secondary:#667781;--wa-border-color:#e9edef;--wa-active-tab-indicator:var(--wa-accent-blue);--wa-button-color:#008069;--wa-link-color:#00a8e8;--wa-shadow:rgba(17,27,33,0.15);--call-end-red:#e91e63;--call-accept-green:#4CAF50;--modal-bg:#f7f7f7;--modal-border-radius:12px;--modal-shadow:0 8px 25px rgba(0,0,0,0.3);--calc-bg:#1c1c1c;--calc-display-bg:#1c1c1c;--calc-btn-bg:#505050;--calc-btn-op-bg:#FF9500;--calc-btn-other-bg:#D4D4D2;--calc-text-primary:#FFFFFF;--calc-text-op:#FFFFFF;--calc-text-other:#1c1c1c;}
*{box-sizing:border-box;margin:0;padding:0;font-family:'Roboto',sans-serif;}
html,body{width:100%;height:100%;overflow:hidden;background-color:#d1d7db;display:flex;align-items:center;justify-content:center;color:var(--wa-text-primary);}
.hidden{display:none!important;}
::-webkit-scrollbar{width:6px;}
::-webkit-scrollbar-track{background:#f1f1ff;}
::-webkit-scrollbar-thumb{background:#c1c1c1;border-radius:6px;}
::-webkit-scrollbar-thumb:hover{background:#a8a8a8;}
#app-container{width:100%;height:100%;max-width:450px;max-height:950px;background-color:var(--wa-app-bg);border-radius:8px;box-shadow:0 4px 12px var(--wa-shadow);display:flex;flex-direction:column;overflow:hidden;position:relative;}
.view{width:100%;height:100%;display:flex;flex-direction:column;background-color:var(--wa-app-bg);position:absolute;top:0;left:0;transition:transform 0.3s ease,opacity 0.3s ease;}
.view.hidden{transform:translateX(100%);opacity:0;pointer-events:none;}
#auth-view.hidden{transform:scale(0.9);opacity:0;}
#calculator-view.hidden{transform:scale(1.1);opacity:0;pointer-events:none;}
.view:not(.hidden){transform:translateX(0);opacity:1;}
#calculator-view:not(.hidden){transform:scale(1);opacity:1;}
.icon-btn{background:none;border:none;cursor:pointer;padding:8px;border-radius:50%;display:flex;align-items:center;justify-content:center;}
.icon-btn svg{width:24px;height:24px;fill:var(--wa-icon-color);}
.icon-btn:hover{background-color:rgba(255,255,255,0.1);}
#calculator-view{background-color:var(--calc-bg);padding:20px;justify-content:flex-end;flex-direction:column;gap:20px;z-index:100;position:relative;}
#calc-notification-badge{position:absolute;top:20px;left:50%;transform:translateX(-50%);background-color:var(--wa-accent-blue);color:white;border-radius:50%;min-width:24px;height:24px;font-size:0.85rem;font-weight:500;display:flex;align-items:center;justify-content:center;z-index:110;padding:2px;box-shadow:0 2px 4px rgba(0,0,0,0.2);transition:transform 0.3s ease,opacity 0.3s ease;box-sizing:border-box;}
#calc-notification-badge.hidden{display:flex!important;transform:translateX(-50%) scale(0.5);opacity:0;pointer-events:none;}
#calc-display-wrapper{background-color:var(--calc-display-bg);padding:20px;text-align:right;flex-grow:1;display:flex;flex-direction:column;justify-content:flex-end;}
#calc-display{font-size:4.5rem;font-weight:300;color:var(--calc-text-primary);word-wrap:break-word;word-break:break-all;min-height:1.2em;line-height:1.3;transition:font-size 0.2s;}
#calc-buttons{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;}
.calc-btn{background-color:var(--calc-btn-bg);border:none;border-radius:50%;font-size:2.2rem;color:var(--calc-text-primary);cursor:pointer;aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;transition:filter 0.2s,transform 0.1s;}
.calc-btn:active{transform:scale(0.95);filter:brightness(1.2);}
.calc-btn.span-2-rows{grid-row:span 2;aspect-ratio:1/2.15;border-radius:40px;}
.calc-btn.span-2-cols{grid-column:span 2;aspect-ratio:2.15/1;border-radius:40px;justify-content:flex-start;padding-left:30px;}
.calc-btn.op{background-color:var(--calc-btn-op-bg);color:var(--calc-text-op);}
.calc-btn.other{background-color:var(--calc-btn-other-bg);color:var(--calc-text-other);font-weight:500;}
#auth-view{justify-content:center;align-items:center;padding:20px;gap:20px;background:#f0f2f5;z-index:50;}
.auth-form-container{width:100%;max-width:380px;background:#f0f2f5;padding:30px;border-radius:20px;box-shadow:12px 12px 24px #bebebe,-12px -12px 24px #ffffff;}
#auth-view h1{color:#444;font-size:2rem;font-weight:700;text-align:center;margin-bottom:8px;}
.auth-developer-subtitle{color:#555;font-size:1rem;font-weight:400;text-align:center;margin-bottom:20px;letter-spacing:0.5px;}
.auth-form{display:flex;flex-direction:column;width:100%;gap:20px;}
.auth-form input{border:none;outline:none;background:#f0f2f5;padding:15px 20px;border-radius:10px;font-size:1rem;color:#555;box-shadow:inset 6px 6px 12px #bebebe,inset -6px -6px 12px #ffffff;}
.auth-form input:focus{box-shadow:inset 4px 4px 8px #bebebe,inset -4px -4px 8px #ffffff;}
.auth-btn{padding:15px;background:#f0f2f5;color:#555;border:none;outline:none;border-radius:10px;font-size:1rem;font-weight:700;cursor:pointer;box-shadow:6px 6px 12px #bebebe,-6px -6px 12px #ffffff;transition:all 0.2s ease-in-out;}
.auth-btn:hover{box-shadow:8px 8px 16px #bebebe,-8px -8px 16px #ffffff;}
.auth-btn:active{box-shadow:inset 6px 6px 12px #bebebe,inset -6px -6px 12px #ffffff;color:#333;}
.auth-link{color:#555;text-decoration:none;font-size:0.9rem;text-align:center;cursor:pointer;margin-top:10px;}
.auth-link:hover{text-decoration:underline;}
.error-message{color:var(--call-end-red);font-size:0.9rem;text-align:center;min-height:1.2em;}
#main-view{z-index:10;}
.main-header{background-color:var(--wa-header-bg);color:var(--wa-icon-color);flex-shrink:0;}
.header-top{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;}
.header-top h1{font-size:1.4rem;font-weight:500;}
.header-top-icons{display:flex;gap:8px;}
.header-nav{display:flex;justify-content:space-around;background-color:var(--wa-header-bg);}
.nav-tab{flex:1;text-align:center;padding:14px 0;font-size:1rem;font-weight:500;color:rgba(240,242,245,0.7);cursor:pointer;position:relative;border-bottom:3px solid transparent;transition:color 0.2s,border-bottom-color 0.2s;}
.nav-tab.active{color:var(--wa-accent-blue);border-bottom-color:var(--wa-active-tab-indicator);}
.badge{position:absolute;top:10px;right:20%;background-color:var(--wa-accent-blue);color:white;font-size:0.75rem;font-weight:500;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;line-height:1;padding-top:1px;}
#main-content{flex:1;overflow-y:auto;position:relative;}
.content-panel{width:100%;height:100%;position:absolute;background:#fff;}
.content-panel:not(.active){display:none;}
#home-content.active{display:flex;flex-direction:column;}
.list-item{display:flex;align-items:center;padding:12px 16px;border-bottom:1px solid var(--wa-border-color);cursor:pointer;position:relative;overflow:hidden;background-color:#fff;transition:background-color 0.2s;}
.list-item:hover{background-color:var(--wa-app-bg);}
.delete-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background-color:rgba(233,30,99,0.95);display:flex;align-items:center;justify-content:center;gap:15px;transform:translateX(100%);transition:transform 0.3s ease-out;z-index:5;}
.list-item.deleting .delete-overlay{transform:translateX(0);}
.delete-button,.cancel-delete-button{background:none;border:2px solid white;color:white;padding:8px 16px;border-radius:20px;font-weight:500;font-size:0.9rem;cursor:pointer;transition:background 0.2s;}
.delete-button:hover,.cancel-delete-button:hover{background:rgba(255,255,255,0.2);}
.item-emoji,.item-details,.item-actions{transition:opacity 0.3s ease-out;z-index:10;}
.list-item.deleting .item-emoji,.list-item.deleting .item-details,.list-item.deleting .item-actions{opacity:0.2;pointer-events:none;}
.item-emoji{font-size:2.5rem;margin-right:12px;background:var(--wa-border-color);width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;line-height:1;overflow:hidden;}
.item-emoji img{width:100%;height:100%;object-fit:cover;}
.item-emoji span{font-size:2.5rem;line-height:1;user-select:none;color:var(--wa-text-secondary);}
.item-details{flex:1;overflow:hidden;}
.item-name{font-size:1.1rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.item-subtext{font-size:0.9rem;color:var(--wa-text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.item-actions{display:flex;flex-direction:column;align-items:flex-end;gap:4px;font-size:0.8rem;color:var(--wa-text-secondary);}
.item-actions .badge{position:static;}
.notification-actions{display:flex;gap:8px;margin-top:8px;}
.notif-btn{padding:6px 12px;border:none;border-radius:6px;cursor:pointer;font-weight:500;}
.notif-btn.accept{background-color:var(--wa-button-color);color:white;}
.notif-btn.reject{background-color:var(--wa-border-color);color:var(--wa-text-primary);}
#chat-view{background-color:var(--wa-chat-bg);z-index:60;}
.chat-header{display:flex;align-items:center;gap:8px;background-color:var(--wa-header-bg);color:var(--wa-icon-color);padding:10px;flex-shrink:0;}
.chat-contact-info{display:flex;align-items:center;gap:10px;flex:1;cursor:pointer;}
.chat-contact-info .item-emoji{width:40px;height:40px;font-size:1.8rem;margin-right:0;}
.chat-contact-info .item-emoji span{font-size:1.8rem;}
.chat-contact-details .item-name{color:var(--wa-icon-color);font-size:1.1rem;}
.chat-contact-details .item-subtext{color:rgba(240,242,245,0.8);font-size:0.8rem;}
.chat-header-icons{display:flex;}
#chat-messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:8px;background-image:url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23bdbdbd' fill-opacity='0.15' fill-rule='evenodd'%3E%3Cpath d='M0 40L40 0H20L0 20M40 40V20L20 40'/%3E%3C/g%3E%3C/svg%3E");}
.message-bubble{padding:8px 12px;border-radius:12px;max-width:75%;word-wrap:break-word;box-shadow:0 1px 1px var(--wa-shadow);position:relative;}
.message-sent{align-self:flex-end;background-color:var(--wa-message-out-bg);border-top-right-radius:4px;}
.message-received{align-self:flex-start;background-color:var(--wa-message-in-bg);border-top-left-radius:4px;}
.message-content-wrapper{display:flex;align-items:flex-end;}
.message-text{margin-right:4px;}
.message-time-status{display:flex;align-items:center;font-size:0.75rem;color:var(--wa-text-secondary);user-select:none;line-height:1;margin-left:8px;flex-shrink:0;}
.message-status-icon{width:14px;height:14px;margin-left:4px;fill:var(--wa-text-secondary);}
.message-status-icon.seen{fill:var(--wa-accent-blue);}
#chat-input-container{display:flex;align-items:center;gap:8px;padding:8px 12px;background-color:var(--wa-app-bg);flex-shrink:0;}
#chat-input{flex:1;padding:12px 18px;border:none;border-radius:24px;font-size:1rem;}
#chat-input:focus{outline:none;}
#chat-send-btn{background-color:var(--wa-button-color);border-radius:50%;padding:12px;transition:background-color 0.2s;}
#chat-send-btn:hover{background-color:#006652;}
#chat-send-btn svg{fill:white;width:20px;height:20px;}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:1000;max-width:450px;max-height:950px;margin:auto;}
.modal-content{background:var(--modal-bg);padding:24px;border-radius:var(--modal-border-radius);width:90%;max-width:380px;box-shadow:var(--modal-shadow);display:flex;flex-direction:column;gap:16px;transform:scale(1);transition:transform 0.3s ease-out;}
.modal.hidden{}
.modal.hidden .modal-content{transform:scale(0.95);opacity:0;}
.modal-content h2{font-size:1.6rem;color:var(--wa-header-bg);text-align:center;font-weight:700;}
.modal-content form{display:flex;flex-direction:column;gap:12px;}
.modal-content input{padding:12px;border:1px solid #ccc;border-radius:8px;font-size:1rem;}
.modal-content button{padding:12px;background-color:var(--wa-button-color);color:white;border:none;border-radius:8px;font-size:1rem;cursor:pointer;transition:background-color 0.2s;}
.modal-content button:hover{background-color:#006652;}
.modal-content .close-modal-btn{background-color:#f0f0f0;color:var(--wa-text-primary);}
.modal-content .close-modal-btn:hover{background-color:#e0e0e0;}
.modal-content p{font-size:1rem;color:var(--wa-text-secondary);text-align:center;}
#profile-view-content{gap:15px;}
.profile-info-frame{display:flex;flex-direction:column;align-items:center;gap:10px;padding:16px;background:#fff;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.05);}
#profile-pic-wrapper{font-size:4.5rem;width:110px;height:110px;margin:0;cursor:pointer;color:var(--wa-text-primary);}
#profile-pic-wrapper span{font-size:4.5rem;}
.profile-name-wrapper{display:flex;align-items:center;gap:10px;}
#profile-view-name{font-size:1.8rem;font-weight:700;word-break:break-all;display:flex;align-items:center;}
#profile-edit-name-btn{background:#eee;padding:6px;border-radius:50%;border:none;cursor:pointer;display:flex;}
#profile-edit-name-btn:hover{background:#ddd;}
#profile-edit-name-form{display:flex;gap:8px;margin-top:5px;width:100%;}
#profile-name-input{flex:1;padding:8px;border:1px solid #ccc;border-radius:6px;font-size:1rem;}
#profile-save-name-btn{padding:8px 12px;font-size:0.9rem;}
#profile-view-email{font-size:1rem;color:var(--wa-text-secondary);}
.profile-id-frame{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:#fff;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.05);flex-direction:column;gap:10px;}
.id-wrapper,.email-wrapper{display:flex;align-items:center;justify-content:space-between;width:100%;}
.id-text-wrapper,.email-text-wrapper{display:flex;flex-direction:column;gap:2px;overflow:hidden;}
.id-text-wrapper p,.email-text-wrapper p{font-size:0.8rem;color:var(--wa-text-secondary);}
#profile-user-id-text,#profile-user-email-text{font-size:0.95rem;font-weight:500;color:var(--wa-text-primary);word-break:break-all;}
#profile-copy-id-btn,#profile-copy-email-btn{background:var(--wa-border-color);border-radius:50%;padding:8px;cursor:pointer;flex-shrink:0;margin-left:12px;border:none;}
#profile-copy-id-btn svg,#profile-copy-email-btn svg{fill:var(--wa-text-secondary);width:20px;height:20px;display:block;}
.profile-blocked-frame{display:flex;flex-direction:column;gap:8px;padding:12px 16px;background:#fff;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.05);}
.profile-blocked-frame strong{text-align:center;font-size:1.1rem;color:var(--wa-header-bg);}
#blocked-users-list{max-height:150px;overflow-y:auto;background:#fcfcfc;border-radius:6px;border:1px solid var(--wa-border-color);}
.blocked-user-item{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border-bottom:1px solid var(--wa-border-color);}
.unblock-btn{font-size:0.8rem;padding:4px 10px;background:var(--wa-link-color);border-radius:6px;color:white;border:none;cursor:pointer;}
.unblock-btn:hover{background:#0088c4;}
.profile-button-group{display:flex;flex-direction:column;gap:10px;margin-top:5px;}
#logout-btn{background-color:var(--call-end-red);}
#logout-btn:hover{background-color:#c91652;}

/* --- ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶æ‡¶ü‡¶® ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ --- */
#partner-modal-block-btn { background-color: var(--call-end-red); margin-bottom: 5px; }
#partner-modal-block-btn:hover { background-color: #c91652; }

/* --- ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡ßü‡ßá‡¶° ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ú ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ (‡¶®‡¶§‡ßÅ‡¶®) --- */
.name-with-badge {
    display: flex;
    align-items: center;
    overflow: hidden;
}
.item-name-text {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.2;
}
.verified-badge {
    display: inline-block;
    flex-shrink: 0;
    width: 0.85em; /* ‡¶´‡¶®‡ßç‡¶ü ‡¶∏‡¶æ‡¶á‡¶ú‡ßá‡¶∞ ‡¶ì‡¶™‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶≠‡¶∞‡¶∂‡ßÄ‡¶≤ */
    height: 0.85em;
    background-color: var(--wa-accent-blue);
    border-radius: 50%;
    margin-left: 5px;
    padding: 0.12em;
    box-sizing: border-box;
}
.verified-badge svg {
    width: 100%;
    height: 100%;
    fill: white; 
    stroke: none; 
}
/* ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶™‡ßá‡¶ú‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ ‡¶∏‡¶æ‡¶á‡¶ú */
#profile-view-name .verified-badge {
    width: 0.8em;
    height: 0.8em;
    padding: 0.1em;
}

/* Custom Notification Styles */
#notification-container {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10000; /* Above all */
    display: flex;
    flex-direction: column;
    align-items: center;
    pointer-events: none; /* Allows clicks to pass through */
    max-width: 90%;
}
.custom-notification {
    background-color: rgba(17, 27, 33, 0.9); /* Dark background */
    color: white;
    padding: 12px 20px;
    border-radius: 20px;
    margin-top: 10px;
    font-size: 0.95rem;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    opacity: 0;
    transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
    transform: translateY(100%);
    text-align: center;
    pointer-events: all; /* Make the notification itself clickable/interactable */
    display: flex;
    align-items: center;
    gap: 10px;
}
.custom-notification.show {
    opacity: 1;
    transform: translateY(0);
}
.notification-action-buttons {
    display: flex;
    gap: 8px;
    margin-left: 10px;
}
.notification-action-buttons button {
    background: none;
    border: 1px solid white;
    color: white;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.85rem;
    cursor: pointer;
    pointer-events: all;
}
.notification-action-buttons button:hover {
    background-color: rgba(255, 255, 255, 0.2);
}
/* Custom Prompt Modal */
#custom-prompt-modal {
    background: rgba(0, 0, 0, 0.6);
}
#custom-prompt-modal .modal-content {
    background: var(--modal-bg);
}
</style>
</head>
<body>
<div id="app-container">
<div id="calculator-view" class="view">
<div id="calc-notification-badge" class="hidden">0</div>
<div id="calc-display-wrapper">
<div id="calc-display">0</div>
</div>
<div id="calc-buttons">
<button class="calc-btn other" data-key="clear">C</button>
<button class="calc-btn other" data-key="backspace">‚å´</button>
<button class="calc-btn op" data-key="/">√∑</button>
<button class="calc-btn op" data-key="*">√ó</button>
<button class="calc-btn" data-key="7">7</button>
<button class="calc-btn" data-key="8">8</button>
<button class="calc-btn" data-key="9">9</button>
<button class="calc-btn op" data-key="-">‚àí</button>
<button class="calc-btn" data-key="4">4</button>
<button class="calc-btn" data-key="5">5</button>
<button class="calc-btn" data-key="6">6</button>
<button class="calc-btn op" data-key="+">+</button>
<button class="calc-btn" data-key="1">1</button>
<button class="calc-btn" data-key="2">2</button>
<button class="calc-btn" data-key="3">3</button>
<button class="calc-btn op span-2-rows" data-key="equals">=</button> <button class="calc-btn span-2-cols" data-key="0">0</button> <button class="calc-btn" data-key=".">.</button> </div>
</div>
<div id="auth-view" class="view hidden">
<div class="auth-form-container">
<h1>SECRET MESSAGING</h1>
<p class="auth-developer-subtitle">ùêÉùêÑùêïùêÄùêãùêéùêèùêÑùêë ùêäùêÄùêñùêíùêÄùêë</p>
<form id="login-form" class="auth-form">
<div id="login-error" class="error-message"></div>
<input type="email" id="login-email" placeholder="Email" required>
<input type="password" id="login-password" placeholder="Password" required>
<button type="submit" class="auth-btn">LOGIN</button>
<a id="show-signup" class="auth-link">SIGN UP</a>
</form>
<form id="signup-form" class="auth-form hidden">
<div id="signup-error" class="error-message"></div>
<input type="email" id="signup-email" placeholder="Email" required>
<input type="password" id="signup-password" placeholder="Password" required>
<button type="submit" class="auth-btn">SIGN UP</button>
<a id="show-login" class="auth-link">LOGIN</a>
</form>
</div>
</div>
<div id="main-view" class="view hidden">
<header class="main-header">
<div class="header-top">
<div class="header-title-group">
<h1>ü´Ä</h1>
<p class="app-developer">ùêÄùêèùêè ùêÉùêÑùêïùêÄùêãùêéùêèùêÑùêë ùêäùêÄùêñùêíùêÄùêë</p>
</div>
<div class="header-top-icons">
<button id="add-friend-btn" class="icon-btn" title="Add Friend">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
</button>
<button id="menu-btn" class="icon-btn" title="Profile">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
</button>
</div>
</div>
<nav class="header-nav">
<div id="nav-home" class="nav-tab active">
CHATS <span id="chats-badge" class="badge hidden"></span>
</div>
<div id="nav-calls" class="nav-tab">
ALL FRIEND
</div>
</nav>
</header>
<main id="main-content">
<div id="home-content" class="content-panel active">
</div>
<div id="notifications-content" class="content-panel">
</div>
<div id="calls-content" class="content-panel">
</div>
</main>
</div>
<div id="chat-view" class="view hidden">
<header class="chat-header">
<button id="chat-back-btn" class="icon-btn" title="Back">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
</button>
<div id="chat-header-info" class="chat-contact-info">
<div id="chat-header-pic-wrapper" class="item-emoji"></div>
<div class="chat-contact-details">
<div id="chat-header-name" class="item-name name-with-badge"></div>
<div id="chat-header-status" class="item-subtext"></div>
</div>
</div>
<div class="chat-header-icons">
</div>
</header>
<div id="chat-messages">
</div>
<footer id="chat-input-container">
<input type="text" id="chat-input" placeholder="Type a message...">
<button id="chat-send-btn" class="icon-btn" title="Send">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
</button>
</footer>
</div>
<div id="add-friend-modal" class="modal hidden">
<div class="modal-content">
<h2>ADD FRIEND</h2>
<p>ENTER YOUR FRIEND ID</p>
<form id="add-friend-form">
<input type="text" id="friend-id-input" placeholder="Friend ID" required>
<button type="submit" class="auth-btn">ADD FRIEND</button>
<button type="button" class="close-modal-btn">CANCEL</button>
</form>
</div>
</div>
<div id="profile-view-modal" class="modal hidden">
<div id="profile-view-content" class="modal-content">
<h2>SETTINGS</h2>
<div class="profile-info-frame">
<div id="profile-pic-wrapper" class="item-emoji" title="Click to change picture">
</div>
<div class="profile-name-wrapper">
<h3 id="profile-view-name">YOUR NAME</h3>
<button id="profile-edit-name-btn" class="icon-btn" title="Edit Name">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708l-3-3zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.499.499 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11l.178-.178z"/></svg>
</button>
</div>
<div id="profile-edit-name-form" class="hidden">
<input type="text" id="profile-name-input" placeholder="New Name">
<button id="profile-save-name-btn" class="auth-btn">Save</button>
</div>
<p id="profile-view-email" class="item-subtext"></p>
</div>
<div class="profile-id-frame">
<div class="id-wrapper">
<div class="id-text-wrapper">
<p>YOUR ID</p>
<span id="profile-user-id-text"></span>
</div>
<button id="profile-copy-id-btn" class="icon-btn" title="Copy ID">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20px" height="20px"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0 -1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
</button>
</div>
<div class="id-wrapper" style="margin-top: 10px; border-top: 1px solid var(--wa-border-color); padding-top: 10px;">
<div class="id-text-wrapper">
<p>EMAIL</p>
<span id="profile-user-email-text"></span>
</div>
<button id="profile-copy-email-btn" class="icon-btn" title="Copy Email">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20px" height="20px"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0 -1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
</button>
</div>
</div>

<div class="profile-blocked-frame">
    <strong>Blocked Users</strong>
    <div id="blocked-users-list">
        </div>
</div>

<div class="profile-button-group">
<button id="logout-btn" class="auth-btn">Log Out</button>
<button type="button" class="close-modal-btn">Close</button>
</div>
</div>
</div>
<div id="custom-prompt-modal" class="modal hidden">
    <div class="modal-content">
        <h2 id="prompt-modal-title">Enter Value</h2>
        <form id="custom-prompt-form">
            <input type="text" id="prompt-input" placeholder="Value" required>
            <button type="submit" class="auth-btn">SUBMIT</button>
            <button type="button" class="close-modal-btn">CANCEL</button>
        </form>
    </div>
</div>

<div id="partner-profile-modal" class="modal hidden">
    <div class="modal-content">
        <h2 id="partner-modal-name" class="name-with-badge" style="justify-content: center; font-size: 1.6rem;">Friend's Profile</h2>
        <div class="profile-id-frame">
            <div class="id-wrapper">
                <div class="id-text-wrapper">
                    <p>USER ID</p>
                    <span id="partner-modal-id-text"></span>
                </div>
                <button id="partner-modal-copy-id-btn" class="icon-btn" title="Copy ID">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20px" height="20px"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0 -1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                </button>
            </div>
        </div>
        <div class="profile-button-group">
            <button type="button" id="partner-modal-block-btn" class="auth-btn">Block User</button>
            <button type="button" class="close-modal-btn">Close</button>
        </div>
    </div>
</div>

</div>
<div id="notification-container"></div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
document.addEventListener('DOMContentLoaded',()=>{
const firebaseConfig={apiKey:"AIzaSyBh7oN1SOlJvTdV4ld5JRP6wBRWu-DL_nQ",authDomain:"kawsar-messaging-apps.firebaseapp.com",databaseURL:"https://kawsar-messaging-apps-default-rtdb.firebaseio.com",projectId:"kawsar-messaging-apps",storageBucket:"kawsar-messaging-apps.firebasestorage.app",messagingSenderId:"738233086903",appId:"1:738233086903:web:9357e641d888c2f9a76e32",measurementId:"G-18N3ZJFVKW"};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.database();
let currentUser=null;
let currentUserData=null;
let appInitialized=false;
let authStateInitialized=false;
let authStateResolve=null;
const authReadyPromise=new Promise(resolve=>{authStateResolve=resolve;});
let currentChatPartner=null;
let currentChatListener=null;
let unreadListeners={};
let contactListeners={};
let lastMessageTimestamps={};
let messageElements={};
let calcDisplayValue='0';
let customPromptResolver = null;
const appContainer=document.getElementById('app-container');
const calculatorView=document.getElementById('calculator-view');
const authView=document.getElementById('auth-view');
const mainView=document.getElementById('main-view');
const chatView=document.getElementById('chat-view');
const allViews=document.querySelectorAll('.view');
const addFriendModal=document.getElementById('add-friend-modal');
const profileViewModal=document.getElementById('profile-view-modal');
const customPromptModal=document.getElementById('custom-prompt-modal');
const customPromptForm=document.getElementById('custom-prompt-form');
const promptInput=document.getElementById('prompt-input');
const allModals=document.querySelectorAll('.modal');
const calcDisplay=document.getElementById('calc-display');
const calcButtons=document.getElementById('calc-buttons');
const calcNotificationBadge=document.getElementById('calc-notification-badge');
const loginForm=document.getElementById('login-form');
const signupForm=document.getElementById('signup-form');
const loginError=document.getElementById('login-error');
const signupError=document.getElementById('signup-error');
const addFriendBtn=document.getElementById('add-friend-btn');
const menuBtn=document.getElementById('menu-btn');
const navHome=document.getElementById('nav-home');
const navCalls=document.getElementById('nav-calls');
const homeContent=document.getElementById('home-content');
const callsContent=document.getElementById('calls-content');
const allNavTabs=document.querySelectorAll('.nav-tab');
const allContentPanels=document.querySelectorAll('.content-panel');
const chatsBadge=document.getElementById('chats-badge');
const chatBackBtn=document.getElementById('chat-back-btn');
const chatHeaderInfo=document.getElementById('chat-header-info');
const chatHeaderPicWrapper=document.getElementById('chat-header-pic-wrapper');
const chatHeaderName=document.getElementById('chat-header-name');
const chatMessages=document.getElementById('chat-messages');
const chatInput=document.getElementById('chat-input');
const chatSendBtn=document.getElementById('chat-send-btn');
const addFriendForm=document.getElementById('add-friend-form');
const friendIdInput=document.getElementById('friend-id-input');
const profilePicWrapper=document.getElementById('profile-pic-wrapper');
const profileViewName=document.getElementById('profile-view-name');
const profileViewEmail=document.getElementById('profile-view-email');
const profileEditNameBtn=document.getElementById('profile-edit-name-btn');
const profileEditNameForm=document.getElementById('profile-edit-name-form');
const profileNameInput=document.getElementById('profile-name-input');
const profileSaveNameBtn=document.getElementById('profile-save-name-btn');
const profileUserIdText=document.getElementById('profile-user-id-text');
const profileUserEmailText=document.getElementById('profile-user-email-text');
const profileCopyIdBtn=document.getElementById('profile-copy-id-btn');
const profileCopyEmailBtn=document.getElementById('profile-copy-email-btn');
const notificationContainer = document.getElementById('notification-container');
const partnerProfileModal = document.getElementById('partner-profile-modal');
const partnerModalName = document.getElementById('partner-modal-name');
const partnerModalIdText = document.getElementById('partner-modal-id-text');
const partnerModalCopyIdBtn = document.getElementById('partner-modal-copy-id-btn');

// --- ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶æ‡¶ü‡¶® ‡¶≠‡ßç‡¶Ø‡¶æ‡¶∞‡¶ø‡ßü‡ßá‡¶¨‡¶≤ ---
const blockedUsersListEl = document.getElementById('blocked-users-list');
const partnerModalBlockBtn = document.getElementById('partner-modal-block-btn');

const logoutBtn = document.getElementById('logout-btn');
const showSignupBtn = document.getElementById('show-signup');
const showLoginBtn = document.getElementById('show-login');

// --- Custom Notification Functions ---
function showNotification(message, duration = 3000, actions = null) {
    const notification = document.createElement('div');
    notification.className = 'custom-notification';
    
    const textSpan = document.createElement('span');
    textSpan.textContent = message;
    notification.appendChild(textSpan);

    let notificationTimeout;

    if (actions) {
        const actionWrapper = document.createElement('div');
        actionWrapper.className = 'notification-action-buttons';
        
        actions.forEach(action => {
            const btn = document.createElement('button');
            btn.textContent = action.text;
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                action.callback();
                hideNotification(notification, notificationTimeout);
            });
            actionWrapper.appendChild(btn);
        });
        notification.appendChild(actionWrapper);
        if (!duration) duration = 30000;
    }

    notificationContainer.appendChild(notification);
    
    setTimeout(() => {
        notification.classList.add('show');
    }, 10);

    if (duration > 0) {
        notificationTimeout = setTimeout(() => {
            hideNotification(notification);
        }, duration);
    }
    
    return {
        hide: () => hideNotification(notification, notificationTimeout),
        element: notification,
        timeout: notificationTimeout
    };
}

function hideNotification(notification, timeout) {
    clearTimeout(timeout);
    notification.classList.remove('show');
    notification.addEventListener('transitionend', () => {
        notification.remove();
    }, { once: true });
}

function customConfirm(message) {
    return new Promise(resolve => {
        const actions = [
            { text: 'YES', callback: () => resolve(true) },
            { text: 'NO', callback: () => resolve(false) }
        ];
        showNotification(message, 10000, actions); 
    });
}

function customPrompt(title, defaultValue = '') {
    return new Promise(resolve => {
        customPromptResolver = resolve;
        document.getElementById('prompt-modal-title').textContent = title;
        promptInput.value = defaultValue;
        showModal('custom-prompt-modal');
        history.pushState(null, '', window.location.pathname);
    });
}

customPromptForm.addEventListener('submit', (e) => {
    e.preventDefault();
    if (customPromptResolver) {
        customPromptResolver(promptInput.value);
        customPromptResolver = null;
    }
    showModal('custom-prompt-modal', false);
    if (history.state) history.back();
});

customPromptModal.querySelector('.close-modal-btn').addEventListener('click', () => {
    if (customPromptResolver) {
        customPromptResolver(null);
        customPromptResolver = null;
    }
    showModal('custom-prompt-modal', false);
    if (history.state) history.back();
});

// --- End Custom Notification Functions ---

function showView(viewId){
allViews.forEach(view=>{
view.classList.toggle('hidden',view.id!==viewId);
});
}
function showModal(modalId,show=true){
const modal=document.getElementById(modalId);
if(modal){
modal.classList.toggle('hidden',!show);
}
}
function showPanel(panelId){
allContentPanels.forEach(panel=>{
panel.classList.toggle('active',panel.id===panelId);
});
allNavTabs.forEach(tab=>{
tab.classList.toggle('active',tab.id===`nav-${panelId.split('-')[0]}`);
});
}
function getChatId(uid1,uid2){
return uid1<uid2?`${uid1}_${uid2}`:`${uid2}_${uid1}`;
}
function formatTimestamp(timestamp){
const date=new Date(timestamp);
let hours=date.getHours();
const minutes=date.getMinutes();
const ampm=hours>=12?'PM':'AM';
hours=hours%12;
hours=hours?hours:12;
const minutesStr=minutes<10?'0'+minutes:minutes;
return`${hours}:${minutesStr} ${ampm}`;
}
function getProfilePicHTML(user,placeholderSize='2.5rem'){
if(user.profilePicUrl){
return`<img src="${user.profilePicUrl}" alt="Pic">`;
}else{
const name=user.name||user.uid;
const placeholder=name?name.charAt(0).toUpperCase():'?';
return`<span style="font-size: ${placeholderSize}; line-height: 1; user-select: none;">${placeholder}</span>`;
}
}

// --- ‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®: ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡ßü‡ßá‡¶° ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ú (‡¶®‡¶§‡ßÅ‡¶®) ---
function getVerifiedBadgeHTML(user) {
    if (user && user.isVerified === true) {
        // SVG Checkmark (‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡ßá‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡ßá ‡¶•‡¶æ‡¶ï‡¶æ ‡¶™‡¶æ‡¶•)
        return `
        <span class="verified-badge" title="Verified">
            <svg viewBox="0 0 16 16">
                <path d="M6.75 12.13l-3.48-3.48c-.3-.3-.78-.3-1.06 0s-.3.78 0 1.06l4 4c.3.3.78.3 1.06 0l8.5-8.5c.3-.3.3-.78 0-1.06s-.78-.3-1.06 0L6.75 12.13z"/>
            </svg>
        </span>`;
    }
    return ''; // ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡ßü‡ßá‡¶° ‡¶®‡¶æ ‡¶π‡¶≤‡ßá ‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶Ç
}

function cleanupListeners(){
    if(currentChatListener)currentChatListener.off();
    if(contactListeners.currentUser) contactListeners.currentUser.off(); // <-- ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá
    Object.values(unreadListeners).forEach(listener=>{
        if(listener&&typeof listener.off==='function'){
            listener.off();
        }
    });
    Object.values(contactListeners).forEach(listener=>{
        if(listener&&typeof listener.off==='function'){
            listener.off();
        }
    });
    unreadListeners={};
    contactListeners={};
    currentChatListener=null;
    lastMessageTimestamps={};
    messageElements={};
}
function copyText(text,message){
if(!text)return;
try{
const el=document.createElement('textarea');
el.value=text;
el.setAttribute('readonly','');
el.style.position='absolute';
el.style.left='-9999px';
document.body.appendChild(el);
const selected=document.getSelection().rangeCount>0
?document.getSelection().getRangeAt(0)
:false;
el.select();
document.execCommand('copy');
document.body.removeChild(el);
if(selected){
document.getSelection().removeAllRanges();
document.getSelection().addRange(selected);
}
showNotification(message);
}catch(err){
console.error('Failed to copy text: ',err);
showNotification('Failed to copy. See console for details.', 5000);
}
}
function handleCustomBack(){
    if(!partnerProfileModal.classList.contains('hidden')){
        showModal('partner-profile-modal', false);
        return true;
    }
    if(!profileViewModal.classList.contains('hidden')){
        showModal('profile-view-modal',false);
        return true;
    }
    if(!addFriendModal.classList.contains('hidden')){
        showModal('add-friend-modal',false);
        return true;
    }
    if(!chatView.classList.contains('hidden')){
        chatBackBtn.click();
        return true;
    }
    if(!authView.classList.contains('hidden')){
        showView('calculator-view');
        return true;
    }
    if(!mainView.classList.contains('hidden')){
        if(!homeContent.classList.contains('active')){
            showPanel('home-content');
            return true;
        }else{
            showView('calculator-view');
            return true;
        }
    }
    if(!calculatorView.classList.contains('hidden')){
        return false;
    }
    return false;
}
window.addEventListener('popstate',(event)=>{
const handled=handleCustomBack();
if(handled){
history.pushState(null,'',window.location.pathname);
}
});
history.pushState(null,'',window.location.pathname);
function updateCalcDisplay(){
if(calcDisplayValue.length>9){
calcDisplay.style.fontSize='2.5rem';
}else if(calcDisplayValue.length>6){
calcDisplay.style.fontSize='3.5rem';
}else{
calcDisplay.style.fontSize='4.5rem';
}
calcDisplay.textContent=calcDisplayValue;
}
calcButtons.addEventListener('click',(e)=>{
const button=e.target.closest('.calc-btn');
if(!button)return;
const key=button.dataset.key;
const lastChar=calcDisplayValue[calcDisplayValue.length-1];
const operators=['/','*','-','+'];
if(key==='clear'){
calcDisplayValue='0';
}else if(key==='backspace'){
if(calcDisplayValue.length>1){
calcDisplayValue=calcDisplayValue.slice(0,-1);
}else{
calcDisplayValue='0';
}
}else if(key==='.'){
if(lastChar!=='.'){
calcDisplayValue+=key;
}
}else if(key==='equals'){
if(calcDisplayValue==='59+59'){
calcDisplayValue='0';
updateCalcDisplay();
authReadyPromise.then(()=>{
if(currentUser){
if(currentUserData){
if(appInitialized){
showView('main-view');
history.pushState(null,'',window.location.pathname);
}else{
initializeApp();
}
}else{
showView('auth-view');
history.pushState(null,'',window.location.pathname);
}
}else{
showView('auth-view');
history.pushState(null,'',window.location.pathname);
}
});
}else{
try{
let expression=calcDisplayValue
.replace(/√ó/g,'*')
.replace(/√∑/g,'/')
.replace(/‚àí/g,'-');
if(operators.includes(expression[expression.length-1])){
expression=expression.slice(0,-1);
}
const result=new Function('return '+expression)();
calcDisplayValue=String(Number(result.toFixed(4)));
}catch(err){
calcDisplayValue='Error';
}
}
}else if(operators.includes(key)){
if(operators.includes(lastChar)){
calcDisplayValue=calcDisplayValue.slice(0,-1)+key;
}else{
calcDisplayValue+=key;
}
}else{
if(calcDisplayValue==='0'||calcDisplayValue==='Error'){
calcDisplayValue=key;
}else{
calcDisplayValue+=key;
}
}
updateCalcDisplay();
});
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
.then(()=>{
initializeAuthListener();
})
.catch((error)=>{
console.error("Error setting auth persistence: ",error);
initializeAuthListener();
});

// --- üõë ‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶ï‡ßã‡¶° ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßã‡¶° ‡¶∂‡ßÅ‡¶∞‡ßÅ üõë ---
// ‡¶è‡¶á ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶ü‡¶ø ‡¶è‡¶ñ‡¶® ‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶≤-‡¶ü‡¶æ‡¶á‡¶Æ‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá
function initializeAuthListener(){
    auth.onAuthStateChanged(user=>{
        cleanupListeners();
        if(user){
            currentUser=user;
            
            // --- ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®: .once() ‡¶ï‡ßá .on() ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá ---
            const userRef = db.ref('users/'+user.uid);
            if(contactListeners.currentUser) contactListeners.currentUser.off();
            contactListeners.currentUser = userRef; // ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
            
            userRef.on('value', snapshot => {
                const wasNotInitialized = !currentUserData; // ‡¶è‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡¶¨‡¶æ‡¶∞ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
                
                if(snapshot.exists()){
                    currentUserData = snapshot.val();
                    
                    if (!currentUserData.blockedUsers) {
                        currentUserData.blockedUsers = {};
                    }

                    // ‡¶Ø‡¶¶‡¶ø ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶Æ‡ßã‡¶°‡¶æ‡¶≤ ‡¶ñ‡ßã‡¶≤‡¶æ ‡¶•‡¶æ‡¶ï‡ßá, ‡¶§‡¶¨‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶°‡ßá‡¶ü‡¶æ ‡¶¶‡¶ø‡ßü‡ßá ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®
                    if (!profileViewModal.classList.contains('hidden')) {
                        profilePicWrapper.innerHTML = getProfilePicHTML(currentUserData, '4.5rem');
                        profileViewName.innerHTML = `${currentUserData.name}${getVerifiedBadgeHTML(currentUserData)}`;
                        profileViewEmail.textContent = currentUserData.email;
                        profileUserEmailText.textContent = currentUserData.email;
                    }
                    
                    // ‡¶è‡¶á ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶ó‡ßÅ‡¶≤‡ßã ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡¶¨‡¶æ‡¶∞ ‡¶ö‡¶≤‡¶≤‡ßá‡¶á ‡¶π‡¶¨‡ßá
                    if (wasNotInitialized) {
                        listenForBlockedUsers(user.uid);
                        listenForUnreadCounts();
                    }

                } else {
                    currentUserData = null; // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶π‡ßü‡ßá ‡¶ó‡ßá‡¶≤‡ßá
                }
 
                // auth state promise ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡¶¨‡¶æ‡¶∞ resolve ‡¶ï‡¶∞‡ßÅ‡¶®
                if(!authStateInitialized){
                    authStateInitialized=true;
                    authStateResolve();
                }
            });
        }else{
            currentUser=null;
            currentUserData=null;
            appInitialized=false;
            if(authStateInitialized){
                showView('calculator-view');
            }
            if(calcNotificationBadge){
                calcNotificationBadge.classList.add('hidden');
                calcNotificationBadge.textContent='0';
            }
            if(!authStateInitialized){
                authStateInitialized=true;
                authStateResolve();
            }
        }
    });
}
// --- üõë ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßã‡¶° ‡¶∂‡ßá‡¶∑ üõë ---


// --- ‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®: ‡¶¨‡ßç‡¶≤‡¶ï‡¶° ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶¶‡ßá‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶∂‡ßã‡¶®‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ---
function listenForBlockedUsers(uid) {
    const blockedRef = db.ref('blockedUsers/' + uid);
    if(contactListeners.blocked) contactListeners.blocked.off();
    
    blockedRef.on('value', snapshot => {
        currentUserData.blockedUsers = snapshot.val() || {};
        // ‡¶Ø‡¶¶‡¶ø ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶Æ‡ßã‡¶°‡¶æ‡¶≤ ‡¶ñ‡ßã‡¶≤‡¶æ ‡¶•‡¶æ‡¶ï‡ßá, ‡¶§‡¶¨‡ßá ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡¶ü‡¶ø ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®
        if (!profileViewModal.classList.contains('hidden')) {
            populateBlockedUsersList();
        }
        // --- ‡¶®‡¶§‡ßÅ‡¶®: ‡¶¨‡ßç‡¶≤‡¶ï‡¶° ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶ì‡ßü‡¶æ‡¶∞ ‡¶™‡¶∞ ‡¶ï‡¶®‡ßç‡¶ü‡¶æ‡¶ï‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶∞‡¶ø-‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶® ---
        // (listenForContacts ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ‡¶è‡¶ü‡¶ø ‡¶∏‡ßç‡¶¨‡ßü‡¶Ç‡¶ï‡ßç‡¶∞‡¶ø‡ßü‡¶≠‡¶æ‡¶¨‡ßá ‡¶ï‡¶∞‡¶¨‡ßá)
    });
    contactListeners.blocked = blockedRef;
}

loginForm.addEventListener('submit',(e)=>{
e.preventDefault();
loginError.textContent='';
const email=loginForm['login-email'].value;
const password=loginForm['login-password'].value;
auth.signInWithEmailAndPassword(email,password)
.then((userCredential)=>{
const user=userCredential.user;
db.ref('users/'+user.uid).once('value',snapshot=>{
if(snapshot.exists()){
// currentUserData ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞ ‡¶®‡ßá‡¶á, initializeAuthListener ‡¶è‡¶ü‡¶ø ‡¶ï‡¶∞‡¶¨‡ßá
initializeApp();
}else{
loginError.textContent="Profile data not found. Please contact support.";
auth.signOut(); // ‡¶°‡ßá‡¶ü‡¶æ ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶∏‡¶æ‡¶á‡¶® ‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡ßá ‡¶¶‡¶ø‡¶®
}
});
})
.catch(error=>{
loginError.textContent=error.message;
});
});
signupForm.addEventListener('submit',(e)=>{
e.preventDefault();
signupError.textContent='';
const email=signupForm['signup-email'].value;
const password=signupForm['signup-password'].value;
auth.createUserWithEmailAndPassword(email,password)
.then((userCredential)=>{
const user=userCredential.user;
const defaultProfile={
uid:user.uid,
email:user.email,
name:user.uid,
profilePicUrl:"",
isVerified: false // --- ‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ú‡¶®: ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡ßÅ ---
};
db.ref('users/'+user.uid).set(defaultProfile)
.then(()=>{
loginForm.classList.remove('hidden');
signupForm.classList.add('hidden');
showNotification('Signup successful! Please log in.');
})
.catch(error=>{
signupError.textContent="Signup OK, but failed to create profile: "+error.message;
});
})
.catch(error=>{
signupError.textContent=error.message;
});
});
logoutBtn.addEventListener('click',()=>{
appInitialized=false;
auth.signOut();
showModal('profile-view-modal',false);
});
showSignupBtn.addEventListener('click',()=>{
loginForm.classList.add('hidden');
signupForm.classList.remove('hidden');
});
showLoginBtn.addEventListener('click',()=>{
loginForm.classList.remove('hidden');
signupForm.classList.add('hidden');
});
menuBtn.addEventListener('click',()=>{
if(!currentUserData)return;
profilePicWrapper.innerHTML=getProfilePicHTML(currentUserData,'4.5rem');
// --- ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®: ‡¶®‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ú ‡¶Ø‡ßã‡¶ó ---
profileViewName.innerHTML = `${currentUserData.name}${getVerifiedBadgeHTML(currentUserData)}`;
profileViewEmail.textContent=currentUserData.email;
profileUserIdText.textContent=currentUserData.uid;
profileUserEmailText.textContent=currentUserData.email;
profileEditNameForm.classList.add('hidden');
profileViewName.classList.remove('hidden');
profileEditNameBtn.classList.remove('hidden');

// --- ‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ú‡¶®: ‡¶¨‡ßç‡¶≤‡¶ï‡¶° ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶™‡¶™‡ßÅ‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ---
populateBlockedUsersList();

showModal('profile-view-modal');
history.pushState(null,'',window.location.pathname);
});
profilePicWrapper.addEventListener('click',async()=>{
const newUrl=await customPrompt('Enter new profile picture URL:',currentUserData.profilePicUrl||'');
if(newUrl!==null){
if(newUrl===''||(newUrl.startsWith('http://')||newUrl.startsWith('https://'))){
db.ref(`users/${currentUser.uid}/profilePicUrl`).set(newUrl)
.then(()=>{
currentUserData.profilePicUrl=newUrl;
profilePicWrapper.innerHTML=getProfilePicHTML(currentUserData,'4.5rem');
showNotification('Profile picture updated!');
})
.catch(err=>showNotification('Error: '+err.message));
}else{
showNotification('Invalid URL. Must start with http:// or https://, or be empty.', 5000);
}
}
});
profileEditNameBtn.addEventListener('click',()=>{
profileEditNameForm.classList.remove('hidden');
profileNameInput.value=currentUserData.name;
profileViewName.classList.add('hidden');
profileEditNameBtn.classList.add('hidden');
});
profileSaveNameBtn.addEventListener('click',()=>{
const newName=profileNameInput.value.trim();
if(newName&&newName!==currentUserData.name){
db.ref(`users/${currentUser.uid}/name`).set(newName)
.then(()=>{
currentUserData.name=newName;
// --- ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®: ‡¶®‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ú ‡¶Ø‡ßã‡¶ó ---
profileViewName.innerHTML = `${newName}${getVerifiedBadgeHTML(currentUserData)}`;
showNotification('Name updated!');
if(!currentUserData.profilePicUrl){
profilePicWrapper.innerHTML=getProfilePicHTML(currentUserData,'4.5rem');
}
})
.catch(err=>showNotification('Error: '+err.message))
.finally(()=>{
profileEditNameForm.classList.add('hidden');
profileViewName.classList.remove('hidden');
profileEditNameBtn.classList.remove('hidden');
});
}else{
profileEditNameForm.classList.add('hidden');
profileViewName.classList.remove('hidden');
profileEditNameBtn.classList.remove('hidden');
}
});
profileCopyIdBtn.addEventListener('click',()=>{
copyText(currentUserData.uid,'User ID copied to clipboard!');
});
profileCopyEmailBtn.addEventListener('click',()=>{
copyText(currentUserData.email,'Email copied to clipboard!');
});

partnerModalCopyIdBtn.addEventListener('click',()=>{
    if(currentChatPartner){
        copyText(currentChatPartner.uid,'Friend ID copied to clipboard!');
    }
});

document.querySelectorAll('.close-modal-btn').forEach(btn=>{
btn.addEventListener('click',(e)=>{
const modal=e.target.closest('.modal');
if(modal){
showModal(modal.id,false);
if(history.state){
history.back();
}
}
});
});

chatHeaderInfo.addEventListener('click',()=>{
    if(currentChatPartner){
        // --- ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®: ‡¶®‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ú ‡¶Ø‡ßã‡¶ó ---
        partnerModalName.innerHTML = `${currentChatPartner.name}${getVerifiedBadgeHTML(currentChatPartner)}`;
        partnerModalIdText.textContent = currentChatPartner.uid;
        showModal('partner-profile-modal');
        history.pushState(null,'',window.location.pathname);
    }
});

function initializeApp(){
    showView('main-view');
    showPanel('home-content');
    history.pushState(null,'',window.location.pathname);
    listenForContacts();
    // listenForAllFriends(); // <-- ‡¶è‡¶á ‡¶≤‡¶æ‡¶á‡¶®‡¶ü‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá
    appInitialized=true;
}
addFriendBtn.addEventListener('click',()=>{
addFriendForm.reset();
showModal('add-friend-modal');
history.pushState(null,'',window.location.pathname);
});
addFriendForm.addEventListener('submit',(e)=>{
e.preventDefault();
const friendId=friendIdInput.value.trim();
if(friendId===currentUser.uid){
showNotification("You can't add yourself as a friend.", 5000);
return;
}
db.ref('users/'+friendId).once('value',snapshot=>{
if(snapshot.exists()){
// --- ‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ú‡¶®: ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ ‡¶¨‡ßç‡¶≤‡¶ï‡¶° ‡¶ï‡¶ø‡¶®‡¶æ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶® ---
if(currentUserData.blockedUsers && currentUserData.blockedUsers[friendId]){
    showNotification("This user is in your block list. Unblock them from Settings to add.", 5000);
    return;
}
    
const myUid = currentUser.uid;
const updates = {};
updates[`contacts/${myUid}/${friendId}`] = true;
updates[`contacts/${friendId}/${myUid}`] = true;

db.ref().update(updates).then(() => {
    showNotification('Friend added successfully!');
    showModal('add-friend-modal', false);
    if (history.state) history.back();
}).catch(err => {
    showNotification('Error adding friend: ' + err.message, 5000);
});

}else{
showNotification('User not found.', 5000);
}
});
});
function sortChatList(){
const chatItems=Array.from(homeContent.querySelectorAll('.list-item'));
chatItems.sort((a,b)=>{
const uidA=a.dataset.uid;
const uidB=b.dataset.uid;
const timeA=(lastMessageTimestamps[uidA] || {}).timestamp || 0;
const timeB=(lastMessageTimestamps[uidB] || {}).timestamp || 0;
return timeB-timeA;
});
chatItems.forEach(item=>homeContent.appendChild(item));
const noChatsMsgId='no-chats-message';
let noChatsMsg=homeContent.querySelector(`#${noChatsMsgId}`);
const allHiddenOrEmpty=chatItems.length===0||chatItems.every(item=>item.classList.contains('hidden'));
if(allHiddenOrEmpty&&!noChatsMsg){
noChatsMsg=document.createElement('p');
noChatsMsg.id=noChatsMsgId;
noChatsMsg.style.padding='20px';
noChatsMsg.style.textAlign='center';
noChatsMsg.style.color='var(--wa-text-secondary)';
noChatsMsg.textContent='No active chats. Start a new one from the "ALL FRIEND" tab.';
homeContent.appendChild(noChatsMsg);
}else if(!allHiddenOrEmpty&&noChatsMsg){
noChatsMsg.remove();
}
}


// --- üõë ‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶ï‡ßã‡¶° ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßã‡¶° ‡¶∂‡ßÅ‡¶∞‡ßÅ üõë ---
// ‡¶è‡¶á ‡¶ï‡ßã‡¶°‡¶ü‡¶ø listenForLastMessageUpdates, listenForContacts, ‡¶è‡¶¨‡¶Ç listenForAllFriends
// ‡¶§‡¶ø‡¶®‡¶ü‡¶ø ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶ï‡ßá‡¶á ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶® ‡¶ï‡¶∞‡¶¨‡ßá (replace)‡•§

// --- üöÄ ‡¶®‡¶§‡ßÅ‡¶® ‡¶Ö‡¶™‡ßç‡¶ü‡¶ø‡¶Æ‡¶æ‡¶á‡¶ú‡¶° ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡ß©‡¶ü‡¶ø‡¶∞ ‡¶¨‡¶¶‡¶≤‡ßá ‡¶è‡¶á ‡¶ï‡ßã‡¶°) ---

// ‡¶è‡¶ï‡¶ü‡¶ø helper ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ‡¶Ø‡¶æ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶¨‡¶æ ‡¶´‡ßç‡¶∞‡ßá‡¶®‡ßç‡¶° ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶§‡ßà‡¶∞‡¶ø ‡¶¨‡¶æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßá
function createOrUpdateContactItem(contact, isFriendList = false) {
    const listContainer = isFriendList ? callsContent : homeContent;
    const existingItem = listContainer.querySelector(`.list-item[data-uid="${contact.uid}"]`);
    
    // --- ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®: ‡¶¨‡ßç‡¶≤‡¶ï‡¶° ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶π‡¶≤‡ßá ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá‡¶® ‡¶®‡¶æ ‡¶¨‡¶æ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡ßá ‡¶¶‡¶ø‡¶® ---
    if (currentUserData.blockedUsers && currentUserData.blockedUsers[contact.uid]) {
        if (existingItem) {
            existingItem.remove();
        }
        return; // ‡¶è‡¶á ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶ï‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã‡¶∞ ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞ ‡¶®‡ßá‡¶á
    }

    const lastMsgData = lastMessageTimestamps[contact.uid] || { text: 'Tap to chat', timestamp: 0 };
    const lastMsgText = lastMsgData.text;
    const timestamp = lastMsgData.timestamp;

    if (existingItem) {
        // ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡¶ü‡¶ø ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
        existingItem.querySelector('.item-emoji').innerHTML = getProfilePicHTML(contact);
        existingItem.querySelector('.item-name-text').textContent = contact.name;
        
        const badgeContainer = existingItem.querySelector('.item-name.name-with-badge');
        const oldBadge = badgeContainer.querySelector('.verified-badge');
        if (oldBadge) oldBadge.remove(); // ‡¶™‡ßÅ‡¶∞‡¶®‡ßã ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ú (‡¶Ø‡¶¶‡¶ø ‡¶•‡¶æ‡¶ï‡ßá) ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
        badgeContainer.insertAdjacentHTML('beforeend', getVerifiedBadgeHTML(contact)); // ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ú ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®

        if (!isFriendList) {
            existingItem.querySelector('.item-subtext').textContent = lastMsgText;
            existingItem.classList.toggle('hidden', timestamp === 0);
        }
    } else {
        // ‡¶®‡¶§‡ßÅ‡¶® ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®
        const item = document.createElement('div');
        item.className = 'list-item';
        if (!isFriendList && timestamp === 0) {
             item.classList.add('hidden');
        }
        item.dataset.uid = contact.uid;
        
        let itemHTML = `
            <div class="item-emoji">${getProfilePicHTML(contact)}</div>
            <div class="item-details">
                <div class="item-name name-with-badge">
                    <span class="item-name-text">${contact.name}</span>
                    ${getVerifiedBadgeHTML(contact)}
                </div>
        `;

        if (isFriendList) {
            itemHTML += `</div>`; // .item-details ‡¶¨‡¶®‡ßç‡¶ß
        } else {
            // ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ö‡¶§‡¶ø‡¶∞‡¶ø‡¶ï‡ßç‡¶§ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü
            itemHTML += `
                    <div class="item-subtext" id="subtext-${contact.uid}">${lastMsgText}</div>
                </div>
                <div class="item-actions">
                    <span class="badge hidden" id="badge-${contact.uid}"></span>
                </div>
                <div class="delete-overlay">
                    <button class="delete-button" data-uid="${contact.uid}">Delete Chat</button>
                    <button class="cancel-delete-button" data-uid="${contact.uid}">Cancel</button>
                </div>
            `;
        }
        item.innerHTML = itemHTML + '</div>'; // ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶¨‡¶®‡ßç‡¶ß

        item.addEventListener('click',(e)=>{
            if (isFriendList) {
                openChat(contact);
                return;
            }
            if(!item.classList.contains('deleting')&&!e.target.closest('.delete-button')&&!e.target.closest('.cancel-delete-button')){
                openChat(contact);
            }
        });

        // ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶≤‡¶ú‡¶ø‡¶ï
        if (!isFriendList) {
            let timer;
            item.addEventListener('mousedown',(e)=>{
                if(e.button!==0||e.target.closest('.delete-overlay'))return;
                timer=setTimeout(()=>{
                document.querySelectorAll('.list-item.deleting').forEach(li=>{
                if(li!==item)li.classList.remove('deleting');
                });
                item.classList.add('deleting');
                },500);
            });
            item.addEventListener('touchstart',(e)=>{
                if(e.target.closest('.delete-overlay'))return;
                timer=setTimeout(()=>{
                document.querySelectorAll('.list-item.deleting').forEach(li=>{
                if(li!==item)li.classList.remove('deleting');
                });
                item.classList.add('deleting');
                },500);
            });
            item.addEventListener('mouseup',()=>clearTimeout(timer));
            item.addEventListener('mouseleave',()=>clearTimeout(timer));
            item.addEventListener('touchend',()=>clearTimeout(timer));
            item.addEventListener('touchcancel',()=>clearTimeout(timer));
            item.querySelector('.delete-button').addEventListener('click',async(e)=>{
                e.stopPropagation();
                const isConfirmed = await customConfirm('Are you sure you want to delete this chat history?');
                if(isConfirmed) {
                    deleteChatHistory(contact.uid);
                } else {
                    item.classList.remove('deleting');
                }
            });
            item.querySelector('.cancel-delete-button').addEventListener('click',(e)=>{
                e.stopPropagation();
                item.classList.remove('deleting');
            });
        }
        
        listContainer.appendChild(item);
    }

    if (!isFriendList) {
        sortChatList();
    }
}


function listenForLastMessageUpdates(contactId) {
    if (currentUserData.blockedUsers && currentUserData.blockedUsers[contactId]) {
        return;
    }
    
    const chatId = getChatId(currentUser.uid, contactId);
    const messagesRef = db.ref('messages/' + chatId).limitToLast(1);
    
    if (contactListeners[contactId + '_msg']) contactListeners[contactId + '_msg'].off();
    contactListeners[contactId + '_msg'] = messagesRef;

    messagesRef.on('child_added', snapshot => {
        const msg = snapshot.val();
        if (currentUserData.blockedUsers && currentUserData.blockedUsers[msg.senderId]) {
            return;
        }
        
        const sender = msg.senderId === currentUser.uid ? 'You: ' : '';
        lastMessageTimestamps[contactId] = {
            text: `${sender}${msg.text}`,
            timestamp: msg.timestamp
        };
        
        const item = homeContent.querySelector(`.list-item[data-uid="${contactId}"]`);
        if (item) {
            item.querySelector('.item-subtext').textContent = `${sender}${msg.text}`;
            item.classList.remove('hidden');
            sortChatList();
        }
    });
    
    messagesRef.on('child_removed', () => {
         db.ref('messages/' + chatId).limitToLast(1).once('value', snapshot => {
            const item = homeContent.querySelector(`.list-item[data-uid="${contactId}"]`);
            if (!item) return;
            
            if (snapshot.exists()) {
                snapshot.forEach(child => {
                    const msg = child.val();
                    const sender = msg.senderId === currentUser.uid ? 'You: ' : '';
                    lastMessageTimestamps[contactId] = { text: `${sender}${msg.text}`, timestamp: msg.timestamp };
                    if (item) item.querySelector('.item-subtext').textContent = `${sender}${msg.text}`;
                });
            } else {
                lastMessageTimestamps[contactId] = { text: 'Tap to chat', timestamp: 0 };
                if (item) {
                    item.querySelector('.item-subtext').textContent = 'Tap to chat';
                    item.classList.add('hidden');
                }
            }
            sortChatList();
         });
    });
}

function listenToContactListeners(contactId) {
    // ‡¶è‡¶á ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶ü‡¶ø ‡¶è‡¶ï‡¶ú‡¶® ‡¶ï‡¶®‡ßç‡¶ü‡¶æ‡¶ï‡ßç‡¶ü‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶è‡¶¨‡¶Ç ‡¶≤‡¶æ‡¶∏‡ßç‡¶ü ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶∂‡ßã‡¶®‡ßá
    
    // --- ‡ßß. ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞ ---
    // ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶°‡ßá‡¶ü‡¶æ (‡¶®‡¶æ‡¶Æ, ‡¶õ‡¶¨‡¶ø, ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏) ‡¶∂‡ßã‡¶®‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
    const userRef = db.ref('users/' + contactId);
    if (contactListeners[contactId + '_user']) contactListeners[contactId + '_user'].off();
    contactListeners[contactId + '_user'] = userRef;

    userRef.on('value', snapshot => {
        if (snapshot.exists()) {
            const contact = snapshot.val();
            createOrUpdateContactItem(contact, false); // ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
            createOrUpdateContactItem(contact, true);  // ‡¶´‡ßç‡¶∞‡ßá‡¶®‡ßç‡¶° ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
        }
    });

    // --- ‡ß®. ‡¶≤‡¶æ‡¶∏‡ßç‡¶ü ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞ (‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø) ---
    listenForLastMessageUpdates(contactId);
}

function stopListeningToContact(contactId) {
    // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶π‡ßü‡ßá ‡¶ó‡ßá‡¶≤‡ßá ‡¶§‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞‡¶ó‡ßÅ‡¶≤‡ßã ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶æ
    if (contactListeners[contactId + '_user']) {
        contactListeners[contactId + '_user'].off();
        delete contactListeners[contactId + '_user'];
    }
    if (contactListeners[contactId + '_msg']) {
        contactListeners[contactId + '_msg'].off();
        delete contactListeners[contactId + '_msg'];
    }
    
    // UI ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü
    const chatItem = homeContent.querySelector(`.list-item[data-uid="${contactId}"]`);
    if (chatItem) chatItem.remove();
    
    const friendItem = callsContent.querySelector(`.list-item[data-uid="${contactId}"]`);
    if (friendItem) friendItem.remove();

    delete lastMessageTimestamps[contactId];
}


function listenForContacts() {
    // ‡¶è‡¶á ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶ü‡¶ø ‡¶è‡¶ñ‡¶® ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶ï‡¶®‡ßç‡¶ü‡¶æ‡¶ï‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá ‡¶ï‡ßá ‡¶ï‡ßá ‡¶Ü‡¶õ‡ßá ‡¶§‡¶æ‡¶∞ ‡¶ì‡¶™‡¶∞ ‡¶®‡¶ú‡¶∞ ‡¶∞‡¶æ‡¶ñ‡ßá
    if(contactListeners.main) contactListeners.main.off();
    
    const contactsRef = db.ref('contacts/' + currentUser.uid);
    contactListeners.main = contactsRef;

    // ‡¶Ø‡¶ñ‡¶® ‡¶è‡¶ï‡¶ú‡¶® ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ ‡¶Ø‡ßã‡¶ó ‡¶π‡ßü
    contactsRef.on('child_added', snapshot => {
        const contactId = snapshot.key;
        if (currentUserData.blockedUsers && currentUserData.blockedUsers[contactId]) {
            return; // ‡¶¨‡ßç‡¶≤‡¶ï‡¶° ‡¶π‡¶≤‡ßá ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞ ‡¶®‡ßá‡¶á
        }
        listenToContactListeners(contactId);
    });

    // ‡¶Ø‡¶ñ‡¶® ‡¶è‡¶ï‡¶ú‡¶® ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶π‡ßü
    contactsRef.on('child_removed', snapshot => {
        const contactId = snapshot.key;
        stopListeningToContact(contactId);
        sortChatList(); // ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶∏‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
    });
}

// --- üöÄ ‡¶ï‡ßã‡¶° ‡¶Ö‡¶™‡ßç‡¶ü‡¶ø‡¶Æ‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶æ‡¶® ‡¶∂‡ßá‡¶∑ ---
// --- üõë ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßã‡¶° ‡¶∂‡ßá‡¶∑ üõë ---


function deleteChatHistory(partnerId){
const myUid=currentUser.uid;
const updates={};
const chatId=getChatId(myUid,partnerId);
updates[`messages/${chatId}`]=null;
updates[`unreadCounts/${myUid}/${partnerId}`]=null;
updates[`unreadCounts/${partnerId}/${myUid}`]=null;
db.ref().update(updates)
.then(()=>{
console.log('Chat history deleted.');
showNotification('Chat history deleted.');
})
.catch(err=>{
showNotification(`Error deleting chat: ${err.message}`, 5000);
console.error('Error deleting chat history:',err);
});
}

allNavTabs.forEach(tab=>{
tab.addEventListener('click',()=>{
const panelId=`${tab.id.split('-')[1]}-content`;
showPanel(panelId);
history.pushState(null,'',window.location.pathname);
});
});
function openChat(partner){
currentChatPartner=partner;
chatHeaderPicWrapper.innerHTML=getProfilePicHTML(partner,'1.8rem');
// --- ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®: ‡¶®‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ú ‡¶Ø‡ßã‡¶ó ---
chatHeaderName.innerHTML = `<span class="item-name-text">${partner.name}</span>${getVerifiedBadgeHTML(partner)}`;
chatMessages.innerHTML='';
messageElements={};
showView('chat-view');
history.pushState(null,'',window.location.pathname);
db.ref(`unreadCounts/${currentUser.uid}/${partner.uid}`).remove();
const chatId=getChatId(currentUser.uid,partner.uid);
if(currentChatListener){
currentChatListener.off();
}
const messagesRef=db.ref('messages/'+chatId);
currentChatListener=messagesRef.limitToLast(50);
currentChatListener.on('child_added',snapshot=>{
const msg=snapshot.val();
// --- ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®: ‡¶¨‡ßç‡¶≤‡¶ï‡¶° ‡¶™‡ßç‡¶∞‡ßá‡¶∞‡¶ï‡ßá‡¶∞ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶¨‡ßá‡¶® ‡¶®‡¶æ ---
if (currentUserData.blockedUsers && currentUserData.blockedUsers[msg.senderId]) {
    return;
}
renderMessage(snapshot.key,msg);
if(msg.receiverId===currentUser.uid&&msg.status!=='seen'){
messagesRef.child(snapshot.key).update({status:'seen'});
}
});
messagesRef.on('child_changed',snapshot=>{
const msg=snapshot.val();
if(msg.senderId===currentUser.uid&&msg.receiverId===partner.uid&&messageElements[snapshot.key]){
updateMessageStatus(snapshot.key,msg.status);
}
});
}
function getStatusSVG(status){
const baseClass='message-status-icon';
const isSeen=status==='seen';
const fill=isSeen?'var(--wa-accent-blue)':'var(--wa-text-secondary)';
const svgPath=isSeen
?'M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z'
:'M9.01 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9.01 16.2zm7-9.9l1.4 1.4L9 16.2l-1.4-1.4L9 13.4l7-7z';
return`
<svg class="${baseClass} ${isSeen?'seen':''}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${fill}">
<path d="${svgPath}"/>
</svg>
`;
}
function renderMessage(msgId,msg){
const isSent=msg.senderId===currentUser.uid;
if(messageElements[msgId])return;
const bubble=document.createElement('div');
bubble.className=`message-bubble ${isSent?'message-sent':'message-received'}`;
bubble.id=`msg-${msgId}`;
const contentWrapper=document.createElement('div');
contentWrapper.className='message-content-wrapper';
const textSpan=document.createElement('span');
textSpan.className='message-text';
textSpan.textContent=msg.text;
const timeStatusWrapper=document.createElement('div');
timeStatusWrapper.className='message-time-status';
const timeSpan=document.createElement('span');
timeSpan.textContent=formatTimestamp(msg.timestamp);
timeStatusWrapper.appendChild(timeSpan);
if(isSent){
const statusIconWrapper=document.createElement('span');
statusIconWrapper.id=`status-${msgId}`;
statusIconWrapper.innerHTML=getStatusSVG(msg.status||'sent');
timeStatusWrapper.appendChild(statusIconWrapper);
}
contentWrapper.appendChild(textSpan);
contentWrapper.appendChild(timeStatusWrapper);
bubble.appendChild(contentWrapper);
chatMessages.appendChild(bubble);
messageElements[msgId]=bubble;
if(chatMessages.scrollHeight-chatMessages.clientHeight<=chatMessages.scrollTop+100){
chatMessages.scrollTop=chatMessages.scrollHeight;
}
}
function updateMessageStatus(msgId,newStatus){
const statusEl=document.getElementById(`status-${msgId}`);
if(statusEl){
statusEl.innerHTML=getStatusSVG(newStatus);
}
}
chatSendBtn.addEventListener('click',sendMessage);
chatInput.addEventListener('keypress',(e)=>{
if(e.key==='Enter'){
sendMessage();
}
});
function sendMessage(){
const text=chatInput.value.trim();
if(text===''||!currentChatPartner)return;
const chatId=getChatId(currentUser.uid,currentChatPartner.uid);
const message={
text:text,
senderId:currentUser.uid,
receiverId:currentChatPartner.uid,
timestamp:firebase.database.ServerValue.TIMESTAMP,
status:'sent'
};
db.ref('messages/'+chatId).push(message);
const unreadRef=db.ref(`unreadCounts/${currentChatPartner.uid}/${currentUser.uid}`);
unreadRef.transaction(count=>(count||0)+1);
chatInput.value='';
chatInput.focus();
}
chatBackBtn.addEventListener('click',()=>{
showView('main-view');
currentChatPartner=null;
if(currentChatListener){
currentChatListener.off();
currentChatListener=null;
}
if(history.state){
}
});
function listenForUnreadCounts(){
const myUid=currentUser.uid;
if(unreadListeners.main)unreadListeners.main.off();
const unreadRoot=db.ref('unreadCounts/'+myUid);
unreadRoot.on('value',snapshot=>{
let totalUnread=0;
const counts=snapshot.val()||{};
// --- ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®: ‡¶¨‡ßç‡¶≤‡¶ï‡¶° ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶¶‡ßá‡¶∞ ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶® ---
const blockedUids = currentUserData.blockedUsers || {};
const filteredCounts = {};
for (const uid in counts) {
    if (!blockedUids[uid]) {
        filteredCounts[uid] = counts[uid];
    }
}

document.querySelectorAll('.list-item').forEach(item=>{
const uid=item.dataset.uid;
if(uid){
const badge=document.getElementById(`badge-${uid}`);
const count=filteredCounts[uid]||0; // ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞‡¶° ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
if(badge){
badge.textContent=count;
badge.classList.toggle('hidden',count===0);
}
}
});
totalUnread=Object.values(filteredCounts).reduce((sum,count)=>sum+count,0); // ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞‡¶° ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
chatsBadge.textContent=totalUnread;
chatsBadge.classList.toggle('hidden',totalUnread===0);
if(calcNotificationBadge){
calcNotificationBadge.textContent=totalUnread;
calcNotificationBadge.classList.toggle('hidden',totalUnread===0);
}
});
unreadListeners.main=unreadRoot;
}

// --- ‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®: ‡¶¨‡ßç‡¶≤‡¶ï‡¶° ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶¶‡ßá‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ---
async function populateBlockedUsersList() {
    if (!blockedUsersListEl) return;
    blockedUsersListEl.innerHTML = '<p style="padding: 8px 12px; color: #666;">Loading...</p>';
    const blockedIds = Object.keys(currentUserData.blockedUsers || {});
    
    if (blockedIds.length === 0) {
        blockedUsersListEl.innerHTML = '<p style="padding: 8px 12px; color: #666;">No users blocked.</p>';
        return;
    }

    blockedUsersListEl.innerHTML = ''; // ‡¶≤‡ßã‡¶°‡¶ø‡¶Ç ‡¶ï‡ßç‡¶≤‡¶ø‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
    
    for (const uid of blockedIds) {
        const userSnap = await db.ref('users/' + uid).once('value');
        if (userSnap.exists()) {
            const user = userSnap.val();
            const item = document.createElement('div');
            item.className = 'blocked-user-item';
            
            // --- ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®: ‡¶®‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ú ‡¶Ø‡ßã‡¶ó ---
            item.innerHTML = `
                <span class="name-with-badge">
                    <span class="item-name-text">${user.name || uid}</span>
                    ${getVerifiedBadgeHTML(user)}
                </span>
                <button class="unblock-btn" data-uid="${uid}">Unblock</button>
            `;
            blockedUsersListEl.appendChild(item);
        } else {
            const item = document.createElement('div');
            item.className = 'blocked-user-item';
            
            // --- ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®: ‡¶®‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ú ‡¶Ø‡ßã‡¶ó (‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ú ‡¶•‡¶æ‡¶ï‡¶¨‡ßá ‡¶®‡¶æ) ---
            item.innerHTML = `
                <span class="name-with-badge">
                    <span class="item-name-text">${uid} (Unknown)</span>
                </span>
                <button class="unblock-btn" data-uid="${uid}">Unblock</button>
            `;
            blockedUsersListEl.appendChild(item);
        }
    }
}

// --- ‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®: ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶®‡¶¨‡ßç‡¶≤‡¶ï ‡¶ï‡¶∞‡¶æ ---
function unblockUser(uid) {
    const myUid = currentUser.uid;
    const updates = {};
    updates[`blockedUsers/${myUid}/${uid}`] = null; // ‡¶¨‡ßç‡¶≤‡¶ï ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶•‡ßá‡¶ï‡ßá ‡¶∞‡¶ø‡¶Æ‡ßÅ‡¶≠
    updates[`contacts/${myUid}/${uid}`] = true;     // ‡¶ï‡¶®‡ßç‡¶ü‡¶æ‡¶ï‡ßç‡¶ü‡ßá ‡¶Ø‡ßã‡¶ó
    updates[`contacts/${uid}/${myUid}`] = true;     // ‡¶ï‡¶®‡ßç‡¶ü‡¶æ‡¶ï‡ßç‡¶ü‡ßá ‡¶Ø‡ßã‡¶ó
    
    db.ref().update(updates)
        .then(() => {
            showNotification('User unblocked and re-added to friends.');
            // 'value' ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞ ‡¶∏‡ßç‡¶¨‡ßü‡¶Ç‡¶ï‡ßç‡¶∞‡¶ø‡ßü‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶ï‡¶∞‡¶¨‡ßá
        })
        .catch(err => {
            showNotification('Error unblocking user: ' + err.message, 5000);
        });
}

// --- ‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®: ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶¨‡ßç‡¶≤‡¶ï ‡¶ï‡¶∞‡¶æ ---
async function blockUser(uid) {
    if (uid === currentUser.uid) {
        showNotification("You cannot block yourself.", 5000);
        return;
    }

    const isConfirmed = await customConfirm(`Block this user? You will be removed from each other's contact lists and chats.`);
    if (!isConfirmed) return;

    const myUid = currentUser.uid;
    const updates = {};
    updates[`blockedUsers/${myUid}/${uid}`] = true; // ‡¶¨‡ßç‡¶≤‡¶ï ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá ‡¶Ø‡ßã‡¶ó
    updates[`contacts/${myUid}/${uid}`] = null;     // ‡¶ï‡¶®‡ßç‡¶ü‡¶æ‡¶ï‡ßç‡¶ü ‡¶•‡ßá‡¶ï‡ßá ‡¶∞‡¶ø‡¶Æ‡ßÅ‡¶≠
    updates[`contacts/${uid}/${myUid}`] = null;     // ‡¶ï‡¶®‡ßç‡¶ü‡¶æ‡¶ï‡ßç‡¶ü ‡¶•‡ßá‡¶ï‡ßá ‡¶∞‡¶ø‡¶Æ‡ßÅ‡¶≠

    // ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü
    const chatId = getChatId(myUid, uid);
    updates[`messages/${chatId}`] = null;
    updates[`unreadCounts/${myUid}/${uid}`] = null;
    updates[`unreadCounts/${uid}/${myUid}`] = null;

    db.ref().update(updates)
        .then(() => {
            showNotification('User blocked and removed from friends.');
            showModal('partner-profile-modal', false);
            chatBackBtn.click(); // ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶≠‡¶ø‡¶â ‡¶•‡ßá‡¶ï‡ßá ‡¶Æ‡ßá‡¶á‡¶® ‡¶≠‡¶ø‡¶â‡¶§‡ßá ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®
            if (history.state) history.back();
        })
        .catch(err => {
            showNotification('Error blocking user: ' + err.message, 5000);
        });
}

// --- ‡¶®‡¶§‡ßÅ‡¶® ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞: ‡¶Ü‡¶®‡¶¨‡ßç‡¶≤‡¶ï ‡¶¨‡¶æ‡¶ü‡¶® ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ---
blockedUsersListEl.addEventListener('click', e => {
    if (e.target.classList.contains('unblock-btn')) {
        const uidToUnblock = e.target.dataset.uid;
        if (uidToUnblock) {
            unblockUser(uidToUnblock);
        }
    }
});

// --- ‡¶®‡¶§‡ßÅ‡¶® ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞: ‡¶¨‡ßç‡¶≤‡¶ï ‡¶¨‡¶æ‡¶ü‡¶® ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ---
partnerModalBlockBtn.addEventListener('click', () => {
    if (currentChatPartner) {
        blockUser(currentChatPartner.uid);
    }
});

});
</script>
</body>
</html>