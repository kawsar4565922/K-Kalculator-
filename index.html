<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Calculator</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        /* --- Fonts and Root Variables --- */
        :root {
            /* CHANGED: Header Background Color */
            --wa-header-bg: #53051D; 
            
            --wa-accent-blue: #34B7F1;
            --wa-message-out-bg: #e1f6fb;
            --wa-message-in-bg: #ffffff;
            
            /* CHANGED: General App Background Color (was #f0f2f5) */
            --wa-app-bg: #FFF2C3;
            
            --wa-chat-bg: #e5ddd5;
            --wa-icon-color: #f0f2f5;
            --wa-text-primary: #111b21;
            --wa-text-secondary: #667781;
            --wa-border-color: #e9edef;
            --wa-active-tab-indicator: var(--wa-accent-blue);
            --wa-button-color: #008069;
            --wa-link-color: #00a8e8;
            --wa-shadow: rgba(17, 27, 33, 0.15);
            --call-end-red: #e91e63;
            --call-accept-green: #4CAF50;
            
            /* NEW: Premium Modal Styling */
            --modal-bg: #f7f7f7;
            --modal-border-radius: 12px;
            --modal-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);

            /* --- NEW: Premium Calculator Colors (iOS Style) --- */
            --calc-bg: #1c1c1c; /* Premium Black */
            --calc-display-bg: #1c1c1c; /* Same as background */
            --calc-btn-bg: #505050; /* Dark Gray Buttons (Numbers) */
            --calc-btn-op-bg: #FF9500; /* Orange Buttons (Operators) */
            --calc-btn-other-bg: #D4D4D2; /* Light Gray Buttons (C, etc.) */
            --calc-text-primary: #FFFFFF; /* Text on dark buttons */
            --calc-text-op: #FFFFFF; /* Text on orange buttons */
            --calc-text-other: #1c1c1c; /* Text on light buttons */
        }

        /* --- Global & General Styles --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #d1d7db;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--wa-text-primary);
        }

        .hidden {
            display: none !important;
        }

        /* --- Custom Scrollbar --- */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1ff;
        }
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 6px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* --- Layout & View Styling --- */
        #app-container {
            width: 100%;
            height: 100%;
            max-width: 450px;
            max-height: 950px;
            background-color: var(--wa-app-bg);
            border-radius: 8px;
            box-shadow: 0 4px 12px var(--wa-shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .view {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: var(--wa-app-bg);
            position: absolute;
            top: 0;
            left: 0;
            transition: transform 0.3s ease, opacity 0.3s ease; /* Added opacity */
        }
        .view.hidden {
            transform: translateX(100%);
            opacity: 0; /* Make hidden views invisible */
            pointer-events: none; /* Prevent interaction */
        }
        /* Specific transitions for calc/auth */
        #auth-view.hidden {
            transform: scale(0.9);
            opacity: 0;
        }
        #calculator-view.hidden {
            transform: scale(1.1);
            opacity: 0;
            pointer-events: none;
        }
        .view:not(.hidden) {
            transform: translateX(0);
            opacity: 1; /* Make active view visible */
        }
        #calculator-view:not(.hidden) {
            transform: scale(1);
            opacity: 1;
        }

        /* --- Generic Icon Button --- */
        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .icon-btn svg {
            width: 24px;
            height: 24px;
            fill: var(--wa-icon-color);
        }
        .icon-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* --- Component-Specific Styling --- */

        /* == NEW: Premium Calculator View == */
        #calculator-view {
            background-color: var(--calc-bg);
            padding: 20px;
            justify-content: flex-end; /* Pushes content to the bottom */
            flex-direction: column; /* CHANGED: Display on top, buttons on bottom */
            gap: 20px;
            z-index: 100; /* Ensure calculator is on top initially */
            position: relative; /* NEW: For notification badge */
        }

        /* NEW: Calculator Notification Badge */
        #calc-notification-badge {
            position: absolute;
            top: 20px; /* Aligns with view padding */
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--wa-accent-blue);
            color: white;
            border-radius: 50%;
            min-width: 24px;
            height: 24px;
            font-size: 0.85rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 110; /* Above display */
            padding: 2px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: transform 0.3s ease, opacity 0.3s ease;
            box-sizing: border-box; /* Ensures padding is included */
        }
        #calc-notification-badge.hidden {
            /* This overrides the global .hidden 'display: none' for animations */
            display: flex !important; 
            transform: translateX(-50%) scale(0.5);
            opacity: 0;
            pointer-events: none;
        }


        #calc-display-wrapper {
            background-color: var(--calc-display-bg);
            padding: 20px;
            text-align: right;
            flex-grow: 1; /* Pushes buttons down */
            display: flex;
            flex-direction: column;
            justify-content: flex-end; /* Aligns number to bottom of display area */
        }
        #calc-display {
            font-size: 4.5rem; /* Bigger text */
            font-weight: 300; /* Thinner font for premium look */
            color: var(--calc-text-primary);
            word-wrap: break-word;
            word-break: break-all;
            min-height: 1.2em;
            line-height: 1.3;
            transition: font-size 0.2s; /* Animate font size change */
        }
        #calc-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px; /* Tighter gap */
        }
        .calc-btn {
            background-color: var(--calc-btn-bg);
            border: none;
            border-radius: 50%; /* iOS style circles */
            font-size: 2.2rem;
            color: var(--calc-text-primary);
            cursor: pointer;
            aspect-ratio: 1 / 1; /* Makes perfect circles */
            display: flex;
            align-items: center;
            justify-content: center;
            transition: filter 0.2s, transform 0.1s;
        }
        .calc-btn:active {
            transform: scale(0.95);
            filter: brightness(1.2); /* Better active state */
        }

        /* NEW: Grid span helpers */
        .calc-btn.span-2-rows {
            grid-row: span 2;
            aspect-ratio: 1 / 2.15; /* Adjust for gap */
            border-radius: 40px; /* Pill shape */
        }
        .calc-btn.span-2-cols {
            grid-column: span 2;
            aspect-ratio: 2.15 / 1; /* Adjust for gap */
            border-radius: 40px; /* Pill shape */
            justify-content: flex-start; /* Align 0 to left */
            padding-left: 30px;
        }

        /* NEW: Color classes */
        .calc-btn.op {
            background-color: var(--calc-btn-op-bg);
            color: var(--calc-text-op);
        }
        .calc-btn.other {
            background-color: var(--calc-btn-other-bg);
            color: var(--calc-text-other);
            font-weight: 500;
        }


        /* == Auth View (NEUMORPHIC RE-DESIGN) == */
        #auth-view {
            justify-content: center;
            align-items: center;
            padding: 20px;
            gap: 20px;
            /* Neumorphic background color */
            background: #f0f2f5; 
            z-index: 50; /* Below calculator, above main */
        }

        /* New container for the soft UI card */
        .auth-form-container {
            width: 100%;
            max-width: 380px;
            background: #f0f2f5;
            padding: 30px;
            border-radius: 20px;
            /* The main "extruded" shadow */
            box-shadow: 12px 12px 24px #bebebe, -12px -12px 24px #ffffff;
        }

        #auth-view h1 {
            /* This styles "SECRET MESSAGING" */
            color: #444; /* Darker gray text */
            font-size: 2rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 8px; /* MODIFIED: Reduced margin */
        }
        
        /* --- NEW STYLE FOR DEVELOPER SUBTITLE --- */
        .auth-developer-subtitle {
            color: #555;
            font-size: 1rem;
            font-weight: 400;
            text-align: center;
            margin-bottom: 20px;
            letter-spacing: 0.5px;
        }
        /* --- END NEW STYLE --- */
        
        .auth-form {
            display: flex;
            flex-direction: column;
            width: 100%;
            gap: 20px; /* Increased gap */
        }
        
        .auth-form input {
            /* This is the "inset" style */
            border: none;
            outline: none;
            background: #f0f2f5;
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 1rem;
            color: #555;
            /* The "inset" or "impressed" shadow */
            box-shadow: inset 6px 6px 12px #bebebe, inset -6px -6px 12px #ffffff;
        }
        
        .auth-form input:focus {
            /* Optional: slightly change shadow on focus */
            box-shadow: inset 4px 4px 8px #bebebe, inset -4px -4px 8px #ffffff;
        }
        
        .auth-btn {
            /* This is the "extruded" button style */
            padding: 15px;
            background: #f0f2f5;
            color: #555; /* Match text color */
            border: none;
            outline: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            /* The "extruded" button shadow */
            box-shadow: 6px 6px 12px #bebebe, -6px -6px 12px #ffffff;
            transition: all 0.2s ease-in-out;
        }
        
        .auth-btn:hover {
            /* Slightly stronger shadow on hover */
            box-shadow: 8px 8px 16px #bebebe, -8px -8px 16px #ffffff;
        }

        .auth-btn:active {
            /* "Pressed" effect by reversing to inset shadow */
            box-shadow: inset 6px 6px 12px #bebebe, inset -6px -6px 12px #ffffff;
            color: #333;
        }
        
        .auth-link {
            color: #555; /* Match style */
            text-decoration: none;
            font-size: 0.9rem;
            text-align: center;
            cursor: pointer;
            margin-top: 10px; /* Add some space */
        }
        
        .auth-link:hover {
            text-decoration: underline;
        }
        
        .error-message {
            color: var(--call-end-red);
            font-size: 0.9rem;
            text-align: center;
            min-height: 1.2em;
        }
        /* == End Auth View Re-design == */


        /* == Main View == */
        #main-view {
            z-index: 10; /* At the bottom */
        }
        .main-header {
            background-color: var(--wa-header-bg);
            color: var(--wa-icon-color);
            flex-shrink: 0;
        }
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
        }
        .header-top h1 {
            font-size: 1.4rem;
            font-weight: 500;
        }
        .header-top-icons {
            display: flex;
            gap: 8px;
        }
        .header-nav {
            display: flex;
            justify-content: space-around;
            background-color: var(--wa-header-bg);
        }
        .nav-tab {
            flex: 1;
            text-align: center;
            padding: 14px 0;
            font-size: 1rem;
            font-weight: 500;
            color: rgba(240, 242, 245, 0.7);
            cursor: pointer;
            position: relative;
            border-bottom: 3px solid transparent;
            transition: color 0.2s, border-bottom-color 0.2s;
        }
        .nav-tab.active {
            color: var(--wa-accent-blue);
            border-bottom-color: var(--wa-active-tab-indicator);
        }

        .badge {
            position: absolute;
            top: 10px;
            right: 20%;
            background-color: var(--wa-accent-blue);
            color: white;
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            padding-top: 1px;
        }

        #main-content {
            flex: 1;
            overflow-y: auto;
            position: relative;
        }
        .content-panel {
            width: 100%;
            height: 100%;
            position: absolute;
            /* Using white for content panels */
            background: #fff;
        }
        .content-panel:not(.active) {
            display: none;
        }

        /* == List Items (for Chats, Updates, Calls) == */
        /* NEW: Ensure chat items are ordered visually */
        #home-content.active { /* MODIFIED: Only apply flex when active */
            display: flex;
            flex-direction: column;
        }

        .list-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid var(--wa-border-color);
            cursor: pointer;
            position: relative; /* For the delete button */
            overflow: hidden; /* Hide the button initially */
            background-color: #fff; /* Ensures background is white for contrast */
            transition: background-color 0.2s;
        }
        .list-item:hover {
            background-color: var(--wa-app-bg);
        }

        /* New: Delete Button Overlay */
        .delete-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(233, 30, 99, 0.95); /* call-end-red with opacity */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px; /* Added gap between buttons */
            transform: translateX(100%); /* Start off-screen */
            transition: transform 0.3s ease-out;
            z-index: 5;
        }
        .list-item.deleting .delete-overlay {
            transform: translateX(0); /* Slide in */
        }

        /* Modified: Delete/Cancel Button Styling */
        .delete-button, .cancel-delete-button {
            background: none;
            border: 2px solid white;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .delete-button:hover, .cancel-delete-button:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        /* Ensure original content is below overlay but clickable when not deleting */
        .item-emoji, .item-details, .item-actions {
            transition: opacity 0.3s ease-out;
            z-index: 10;
        }

        /* When deleting, make other content semi-transparent/unclickable */
        .list-item.deleting .item-emoji,
        .list-item.deleting .item-details,
        .list-item.deleting .item-actions {
            opacity: 0.2;
            pointer-events: none;
        }

        .item-emoji {
            font-size: 2.5rem;
            margin-right: 12px;
            background: var(--wa-border-color);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            overflow: hidden; /* NEW: Ensure img doesn't break border-radius */
        }
        /* NEW: Style for img/span inside item-emoji */
        .item-emoji img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .item-emoji span {
            font-size: 2.5rem;
            line-height: 1;
            user-select: none;
            color: var(--wa-text-secondary);
        }

        .item-details {
            flex: 1;
            overflow: hidden;
        }
        .item-name {
            font-size: 1.1rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .item-subtext {
            font-size: 0.9rem;
            color: var(--wa-text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .item-actions {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
            font-size: 0.8rem;
            color: var(--wa-text-secondary);
        }
        .item-actions .badge {
            position: static;
        }
        /* Specific for notifications */
        .notification-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .notif-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }
        .notif-btn.accept {
            background-color: var(--wa-button-color);
            color: white;
        }
        .notif-btn.reject {
            background-color: var(--wa-border-color);
            color: var(--wa-text-primary);
        }

        /* == Chat View == */
        #chat-view {
            background-color: var(--wa-chat-bg);
            z-index: 60; /* Above auth/main */
        }
        .chat-header {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: var(--wa-header-bg);
            color: var(--wa-icon-color);
            padding: 10px;
            flex-shrink: 0;
        }
        .chat-contact-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            cursor: pointer;
        }
        .chat-contact-info .item-emoji {
            width: 40px;
            height: 40px;
            font-size: 1.8rem;
            margin-right: 0;
        }
        /* NEW: Chat header emoji/pic specific size */
        .chat-contact-info .item-emoji span {
            font-size: 1.8rem;
        }

        .chat-contact-details .item-name {
            color: var(--wa-icon-color);
            font-size: 1.1rem;
        }
        .chat-contact-details .item-subtext {
            color: rgba(240, 242, 245, 0.8);
            font-size: 0.8rem;
        }
        .chat-header-icons {
            display: flex;
            /* REMOVED: Call buttons are now gone, just more options remains */
        }

        #chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            /* The requested chat background pattern */
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23bdbdbd' fill-opacity='0.15' fill-rule='evenodd'%3E%3Cpath d='M0 40L40 0H20L0 20M40 40V20L20 40'/%3E%3C/g%3E%3C/svg%3E");
        }
        .message-bubble {
            padding: 8px 12px;
            border-radius: 12px;
            max-width: 75%;
            word-wrap: break-word;
            box-shadow: 0 1px 1px var(--wa-shadow);
            position: relative; /* For the checkmark/status */
        }
        .message-sent {
            align-self: flex-end;
            background-color: var(--wa-message-out-bg);
            border-top-right-radius: 4px;
        }
        .message-received {
            align-self: flex-start;
            background-color: var(--wa-message-in-bg);
            border-top-left-radius: 4px;
        }
        .message-content-wrapper {
            display: flex;
            align-items: flex-end;
        }
        .message-text {
            margin-right: 4px; /* Space for time/status */
        }
        .message-time-status { /* Wrapper for time and status */
            display: flex;
            align-items: center;
            font-size: 0.75rem;
            color: var(--wa-text-secondary);
            user-select: none;
            line-height: 1;
            margin-left: 8px; /* Separates time/status from text */
            flex-shrink: 0;
        }
        .message-status-icon {
            width: 14px;
            height: 14px;
            margin-left: 4px;
            fill: var(--wa-text-secondary); /* Default sent/delivered color */
        }
        .message-status-icon.seen {
            fill: var(--wa-accent-blue); /* Seen status blue */
        }

        #chat-input-container {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background-color: var(--wa-app-bg);
            flex-shrink: 0;
        }
        #chat-input {
            flex: 1;
            padding: 12px 18px;
            border: none;
            border-radius: 24px;
            font-size: 1rem;
        }
        #chat-input:focus {
            outline: none;
        }
        #chat-send-btn {
            background-color: var(--wa-button-color);
            border-radius: 50%;
            padding: 12px;
            transition: background-color 0.2s;
        }
        #chat-send-btn:hover {
            background-color: #006652;
        }
        #chat-send-btn svg {
            fill: white;
            width: 20px;
            height: 20px;
        }

        /* == Call Views (Keeping styles though buttons are removed, for completeness) == */
        .call-view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #222;
            z-index: 70; /* Above chat */
        }
        /* ... rest of call view styles ... */
        
        /* Copied from your CSS */
        #remote-video, #local-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #local-video {
            width: 100px;
            height: 150px;
            bottom: 20px;
            right: 20px;
            top: auto;
            left: auto;
            border: 1px solid #fff;
            border-radius: 8px;
        }
        .call-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(0,0,0,0.5), rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.7));
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 40px 20px;
        }
        .caller-info {
            text-align: center;
            color: white;
        }
        .caller-info .item-emoji {
            width: 120px;
            height: 120px;
            font-size: 4.5rem;
            margin: 0 auto 16px;
        }
        .caller-info .item-name {
            font-size: 1.8rem;
            font-weight: 500;
        }
        .caller-info .item-subtext {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.8);
        }
        .call-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            width: 100%;
        }
        .call-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 64px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .call-btn svg {
            width: 32px;
            height: 32px;
            fill: white;
        }
        .call-btn.end {
            background-color: var(--call-end-red);
        }
        .call-btn.accept {
            background-color: var(--call-accept-green);
        }
        #voice-call-view .call-overlay {
            background: #333; /* Solid background for voice call */
            justify-content: center;
            gap: 50px;
        }
        #voice-call-view .caller-info {
            margin-top: -100px; /* Pull up a bit */
        }
        /* End copied call styles */


        /* == Modals (NEW Premium Design) == */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7); /* Darker overlay */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            /* Aligns with the app container */
            max-width: 450px;
            max-height: 950px;
            margin: auto;
        }
        .modal-content {
            background: var(--modal-bg);
            padding: 24px;
            border-radius: var(--modal-border-radius);
            width: 90%;
            max-width: 380px; /* Slightly wider max-width */
            box-shadow: var(--modal-shadow);
            display: flex;
            flex-direction: column;
            gap: 16px;
            transform: scale(1);
            transition: transform 0.3s ease-out;
        }
        .modal.hidden {
            /* Global .hidden is display:none, this is for animation if needed */
        }
        .modal.hidden .modal-content {
            transform: scale(0.95);
            opacity: 0;
        }
        .modal-content h2 {
            font-size: 1.6rem; /* Slightly larger title */
            color: var(--wa-header-bg); /* Use accent color for title */
            text-align: center;
            font-weight: 700;
        }
        .modal-content form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .modal-content input {
            padding: 12px; /* Increased padding */
            border: 1px solid #ccc;
            border-radius: 8px; /* Rounded corners for input */
            font-size: 1rem;
        }
        .modal-content button {
            padding: 12px;
            background-color: var(--wa-button-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .modal-content button:hover {
            background-color: #006652;
        }
        .modal-content .close-modal-btn {
            background-color: #f0f0f0;
            color: var(--wa-text-primary);
        }
        .modal-content .close-modal-btn:hover {
            background-color: #e0e0e0;
        }
        .modal-content p {
            font-size: 1rem;
            color: var(--wa-text-secondary);
            text-align: center;
        }

        /* Incoming Call Modal */
        #incoming-call-modal .modal-content {
            background: #fff; /* White background for this modal */
            align-items: center;
        }
        /* Call modal emoji/pic size */
        #incoming-call-modal .item-emoji span {
            font-size: 4.5rem;
        }


        /* == Profile View Modal (MODIFIED) == */
        #profile-view-content {
            gap: 15px; /* Adjust gap */
        }

        /* Frame 1: User Info */
        .profile-info-frame {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            padding: 16px;
            background: #fff; /* White background for this frame */
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* NEW: Profile Pic editing */
        #profile-pic-wrapper {
            font-size: 4.5rem; /* Larger emoji */
            width: 110px;
            height: 110px;
            margin: 0;
            cursor: pointer;
            color: var(--wa-text-primary);
        }
        #profile-pic-wrapper span {
            font-size: 4.5rem;
        }

        /* NEW: Name editing */
        .profile-name-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #profile-view-name {
            font-size: 1.8rem;
            font-weight: 700;
            word-break: break-all; /* Ensure long UIDs wrap */
        }
        #profile-edit-name-btn {
            background: #eee;
            padding: 6px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex; /* Ensure icon is centered */
        }
        #profile-edit-name-btn:hover {
            background: #ddd;
        }
        #profile-edit-name-form {
            display: flex;
            gap: 8px;
            margin-top: 5px;
            width: 100%;
        }
        #profile-name-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1rem;
        }
        #profile-save-name-btn {
            padding: 8px 12px;
            font-size: 0.9rem;
        }

        #profile-view-email { /* NEW: Email style */
            font-size: 1rem;
            color: var(--wa-text-secondary);
        }

        /* Frame 2: User ID & Email */
        .profile-id-frame {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            flex-direction: column; /* Stack ID and Email */
            gap: 10px;
        }
        .id-wrapper, .email-wrapper {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }
        .id-text-wrapper, .email-text-wrapper {
            display: flex;
            flex-direction: column;
            gap: 2px;
            overflow: hidden;
        }
        .id-text-wrapper p, .email-text-wrapper p {
            font-size: 0.8rem;
            color: var(--wa-text-secondary);
        }
        #profile-user-id-text, #profile-user-email-text {
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--wa-text-primary);
            word-break: break-all;
        }

        /* Copy button for ID and Email (reused style) */
        #profile-copy-id-btn, #profile-copy-email-btn {
            background: var(--wa-border-color);
            border-radius: 50%;
            padding: 8px;
            cursor: pointer;
            flex-shrink: 0;
            margin-left: 12px;
            border: none;
        }
        #profile-copy-id-btn svg, #profile-copy-email-btn svg {
            fill: var(--wa-text-secondary);
            width: 20px;
            height: 20px;
            display: block;
        }

        /* Frame 3: Blocked Users */
        .profile-blocked-frame {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 12px 16px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .profile-blocked-frame strong {
            text-align: center;
            font-size: 1.1rem;
            color: var(--wa-header-bg);
        }
        #blocked-users-list {
            max-height: 150px;
            overflow-y: auto;
            background: #fcfcfc;
            border-radius: 6px;
            border: 1px solid var(--wa-border-color);
        }
        .blocked-user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid var(--wa-border-color);
        }
        .unblock-btn {
            font-size: 0.8rem;
            padding: 4px 10px;
            background: var(--wa-link-color);
            border-radius: 6px;
            color: white;
        }
        .unblock-btn:hover {
            background: #0088c4;
        }

        /* Frame 4: Buttons */
        .profile-button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 5px;
        }
        #logout-btn {
            background-color: var(--call-end-red);
        }
        #logout-btn:hover {
            background-color: #c91652;
        }
    </style>
    
</head>
<body>
    <div id="app-container">

        <div id="calculator-view" class="view">
            <div id="calc-notification-badge" class="hidden">0</div>
            
            <div id="calc-display-wrapper">
                <div id="calc-display">0</div>
            </div>
            <div id="calc-buttons">
                <button class="calc-btn other" data-key="clear">C</button>
                <button class="calc-btn other" data-key="backspace">‚å´</button>
                <button class="calc-btn op" data-key="/">√∑</button>
                <button class="calc-btn op" data-key="*">√ó</button>
                <button class="calc-btn" data-key="7">7</button>
                <button class="calc-btn" data-key="8">8</button>
                <button class="calc-btn" data-key="9">9</button>
                <button class="calc-btn op" data-key="-">‚àí</button>
                <button class="calc-btn" data-key="4">4</button>
                <button class="calc-btn" data-key="5">5</button>
                <button class="calc-btn" data-key="6">6</button>
                <button class="calc-btn op" data-key="+">+</button>
                <button class="calc-btn" data-key="1">1</button>
                <button class="calc-btn" data-key="2">2</button>
                <button class="calc-btn" data-key="3">3</button>
                <button class="calc-btn op span-2-rows" data-key="equals">=</button> <button class="calc-btn span-2-cols" data-key="0">0</button> <button class="calc-btn" data-key=".">.</button> </div>
        </div>
        
        <div id="auth-view" class="view hidden">
            <div class="auth-form-container">
                <h1>SECRET MESSAGING</h1>
                <p class="auth-developer-subtitle">ùêÉùêÑùêïùêÄùêãùêéùêèùêÑùêë ùêäùêÄùêñùêíùêÄùêë</p>
            
                <form id="login-form" class="auth-form">
                    <div id="login-error" class="error-message"></div>
                    <input type="email" id="login-email" placeholder="Email" required>
                    <input type="password" id="login-password" placeholder="Password" required>
                    <button type="submit" class="auth-btn">LOGIN</button>
                    <a id="show-signup" class="auth-link">SIGN UP</a>
                </form>

                <form id="signup-form" class="auth-form hidden">
                    <div id="signup-error" class="error-message"></div>
                    <input type="email" id="signup-email" placeholder="Email" required>
                    <input type="password" id="signup-password" placeholder="Password" required>
                    <button type="submit" class="auth-btn">SIGN UP</button>
                    <a id="show-login" class="auth-link">LOGIN</a>
                </form>
            </div>
        </div>
        <div id="main-view" class="view hidden">
            <header class="main-header">
                <div class="header-top">
                    <div class="header-title-group">
                        <h1>ü´Ä</h1>
                        <p class="app-developer">ùêÄùêèùêè ùêÉùêÑùêïùêÄùêãùêéùêèùêÑùêë ùêäùêÄùêñùêíùêÄùêë</p>
                    </div>
                    <div class="header-top-icons">
                        <button id="add-friend-btn" class="icon-btn" title="Add Friend">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                        </button>
                        <button id="menu-btn" class="icon-btn" title="Profile & Settings">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
                        </button>
                    </div>
                </div>
                <nav class="header-nav">
                    <div id="nav-home" class="nav-tab active">
                        CHATS <span id="chats-badge" class="badge hidden"></span>
                    </div>
                    <div id="nav-notifications" class="nav-tab">
                        UPDATES <span id="notifications-badge" class="badge hidden"></span>
                    </div>
                    <div id="nav-calls" class="nav-tab">
                        ALL FRIEND
                    </div>
                </nav>
            </header>

            <main id="main-content">
                <div id="home-content" class="content-panel active">
                    </div>
                <div id="notifications-content" class="content-panel">
                    </div>
                <div id="calls-content" class="content-panel">
                    </div>
            </main>
        </div>

        <div id="chat-view" class="view hidden">
            <header class="chat-header">
                <button id="chat-back-btn" class="icon-btn" title="Back">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                </button>
                <div id="chat-header-info" class="chat-contact-info">
                    <div id="chat-header-pic-wrapper" class="item-emoji"></div>
                    <div class="chat-contact-details">
                        <div id="chat-header-name" class="item-name"></div>
                        <div id="chat-header-status" class="item-subtext"></div>
                    </div>
                </div>
                <div class="chat-header-icons">
                    <button id="chat-more-btn" class="icon-btn" title="More options">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
                    </button>
                </div>
            </header>
            
            <div id="chat-messages">
                </div>

            <footer id="chat-input-container">
                <input type="text" id="chat-input" placeholder="Type a message...">
                <button id="chat-send-btn" class="icon-btn" title="Send">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
            </footer>
        </div>

        <div id="video-call-view" class="view call-view hidden">
            <video id="remote-video" autoplay playsinline></video>
            <video id="local-video" autoplay playsinline muted></video>
            <div class="call-overlay">
                <div class="caller-info">
                    <div id="video-caller-pic-wrapper" class="item-emoji"></div>
                    <div id="video-caller-name" class="item-name">Contact Name</div>
                    <div class="item-subtext">Calling...</div>
                </div>
                <div class="call-controls">
                    <button id="video-end-call-btn" class="call-btn end" title="End Call">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.1-2.66 1.8l-1.12 1.12c-3.26-3.48-3.6-8.87-1.1-12.91C4.3-1.01 8.08-2.13 12-2c3.96.13 7.71 1.25 10.15 3.82 2.72 2.8 3.39 7.03 1.51 10.3l-1.12-1.12c-.79-.7-1.68-1.31-2.66-1.8-.33-.16-.56-.51-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"/></svg>
                    </button>
                </div>
            </div>
        </div>
        <div id="voice-call-view" class="view call-view hidden">
            <audio id="remote-audio" autoplay></audio>
            <div class="call-overlay">
                <div class="caller-info">
                    <div id="voice-caller-pic-wrapper" class="item-emoji"></div>
                    <div id="voice-caller-name" class.item-name">Contact Name</div>
                    <div id="voice-call-status" class="item-subtext">Ringing...</div>
                </div>
                <div class="call-controls">
                    <button id="voice-end-call-btn" class="call-btn end" title="End Call">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.1-2.66 1.8l-1.12 1.12c-3.26-3.48-3.6-8.87-1.1-12.91C4.3-1.01 8.08-2.13 12-2c3.96.13 7.71 1.25 10.15 3.82 2.72 2.8 3.39 7.03 1.51 10.3l-1.12-1.12c-.79-.7-1.68-1.31-2.66-1.8-.33-.16-.56-.51-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"/></svg>
                    </button>
                </div>
            </div>
        </div>

        <div id="add-friend-modal" class="modal hidden">
            <div class="modal-content">
                <h2>ADD FRIEND</h2>
                <p>ENTER YOUR FRIEND ID</p>
                <form id="add-friend-form">
                    <input type="text" id="friend-id-input" placeholder="Friend ID" required>
                    <button type="submit" class="auth-btn">SEND REQUEST</button>
                    <button type="button" class="close-modal-btn">CANCEL</button>
                </form>
            </div>
        </div>

        <div id="profile-view-modal" class="modal hidden">
            <div id="profile-view-content" class="modal-content">
                <h2>YOUR PROFILE</h2>

                <div class="profile-info-frame">
                    <div id="profile-pic-wrapper" class="item-emoji" title="Click to change picture">
                        </div>
                    <div class="profile-name-wrapper">
                        <h3 id="profile-view-name">YOUR NAME</h3>
                        <button id="profile-edit-name-btn" class="icon-btn" title="Edit Name">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708l-3-3zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.499.499 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11l.178-.178z"/></svg>
                        </button>
                    </div>
                    <div id="profile-edit-name-form" class="hidden">
                        <input type="text" id="profile-name-input" placeholder="New Name">
                        <button id="profile-save-name-btn" class="auth-btn">Save</button>
                    </div>
                    <p id="profile-view-email" class="item-subtext"></p>
                </div>

                <div class="profile-id-frame">
                    <div class="id-wrapper">
                        <div class="id-text-wrapper">
                            <p>YOUR ID</p>
                            <span id="profile-user-id-text"></span> 
                        </div>
                        <button id="profile-copy-id-btn" class="icon-btn" title="Copy ID">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20px" height="20px"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0 -1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                        </button>
                    </div>

                    <div class="id-wrapper" style="margin-top: 10px; border-top: 1px solid var(--wa-border-color); padding-top: 10px;">
                        <div class="id-text-wrapper">
                            <p>EMAIL</p>
                            <span id="profile-user-email-text"></span> 
                        </div>
                        <button id="profile-copy-email-btn" class="icon-btn" title="Copy Email">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20px" height="20px"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0 -1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                        </button>
                    </div>
                </div>
                
                <div class="profile-blocked-frame">
                    <strong>BLOCK USERS</strong>
                    <div id="blocked-users-list">
                        </div>
                </div>

                <div class="profile-button-group">
                    <button id="logout-btn" class="auth-btn">Log Out</button>
                    <button type="button" class="close-modal-btn">Close</button>
                </div>
            </div>
        </div>

        <div id="incoming-call-modal" class="modal hidden">
            <div class="modal-content">
                <div id="incoming-caller-info" class="caller-info">
                    <div id="incoming-call-pic-wrapper" class="item-emoji"></div>
                    <div id="incoming-call-name" class="item-name"></div>
                    <div id="incoming-call-type" class="item-subtext">Incoming Call...</div>
                </div>
                <div id="incoming-call-controls" class="call-controls">
                    <button id="reject-call-btn" class="call-btn end" title="Reject">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.1-2.66 1.8l-1.12 1.12c-3.26-3.48-3.6-8.87-1.1-12.91C4.3-1.01 8.08-2.13 12-2c3.96.13 7.71 1.25 10.15 3.82 2.72 2.8 3.39 7.03 1.51 10.3l-1.12-1.12c-.79-.7-1.68-1.31-2.66-1.8-.33-.16-.56-.51-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"/></svg>
                    </button>
                    <button id="accept-call-btn" class="call-btn accept" title="Accept">
                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>
                    </button>
                </div>
            </div>
        </div>

    </div>

    <audio id="ringtone" loop src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU0aT18X//v/P/w/+v/y/9f/p/+n/1n/Uf+x/7H/0//X/9v/3v/e/9v/1//U/8//sP+p/6T/ov+c/5r/nP+e/6H/pv+q/6//sP+z/7T/tP+1/7X/tv+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/7f/t/+3/preE="></audio>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- FIREBASE CONFIG (USE YOUR OWN) ---
            const firebaseConfig = {
                // !!! IMPORTANT: REPLACE WITH YOUR ACTUAL FIREBASE CONFIG !!!
                apiKey: "AIzaSyBh7oN1SOlJvTdV4ld5JRP6wBRWu-DL_nQ",
                authDomain: "kawsar-messaging-apps.firebaseapp.com",
                databaseURL: "https://kawsar-messaging-apps-default-rtdb.firebaseio.com",
                projectId: "kawsar-messaging-apps",
                storageBucket: "kawsar-messaging-apps.firebasestorage.app",
                messagingSenderId: "738233086903",
                appId: "1:738233086903:web:9357e641d888c2f9a76e32",
                measurementId: "G-18N3ZJFVKW"
            };

            // --- INITIALIZE FIREBASE ---
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.database();

            // --- GLOBAL STATE ---
            let currentUser = null;
            let currentUserData = null;
            let appInitialized = false; // <<< MODIFICATION: Flag to check if app is already running
            
            // --- NEW: Auth Ready Promise ---
            let authStateInitialized = false; // Flag
            let authStateResolve = null; // Function to resolve the promise
            const authReadyPromise = new Promise(resolve => {
                authStateResolve = resolve; // Store the resolve function
            });
            // --- END NEW ---
            
            let currentChatPartner = null;
            let currentChatListener = null;
            let unreadListeners = {};
            let contactListeners = {};
            let requestListener = null;
            let callListener = null;
            let lastMessageTimestamps = {}; // NEW: For chat sorting
            let messageElements = {}; // NEW: To quickly find message elements by message ID
            let calcDisplayValue = '0'; // NEW: Calculator state

            // --- WEBRTC STATE ---
            let peerConnection = null;
            let localStream = null;
            let remoteStream = null;
            let incomingCallData = null;
            let activeCallId = null;
            
            // WebRTC STUN server configuration
            const rtcConfig = {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' }
                ]
            };

            // --- DOM ELEMENT REFERENCES ---
            const appContainer = document.getElementById('app-container');
            
            // Views
            const calculatorView = document.getElementById('calculator-view'); // NEW
            const authView = document.getElementById('auth-view');
            const mainView = document.getElementById('main-view');
            const chatView = document.getElementById('chat-view');
            const videoCallView = document.getElementById('video-call-view');
            const voiceCallView = document.getElementById('voice-call-view');
            const allViews = document.querySelectorAll('.view');

            // Modals
            // REMOVED: const profileSetupModal = document.getElementById('profile-setup-modal');
            const addFriendModal = document.getElementById('add-friend-modal');
            const profileViewModal = document.getElementById('profile-view-modal');
            const incomingCallModal = document.getElementById('incoming-call-modal');
            const allModals = document.querySelectorAll('.modal');

            // NEW: Calculator Refs
            const calcDisplay = document.getElementById('calc-display');
            const calcButtons = document.getElementById('calc-buttons');
            const calcNotificationBadge = document.getElementById('calc-notification-badge'); // NEW

            // Auth Forms
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            const loginError = document.getElementById('login-error');
            const signupError = document.getElementById('signup-error');
            const showSignupBtn = document.getElementById('show-signup');
            const showLoginBtn = document.getElementById('show-login');

            // REMOVED: Profile Setup Refs
            // const profileSetupForm = document.getElementById('profile-setup-form');
            // const profileNameInput = document.getElementById('profile-name');
            // const profileEmojiInput = document.getElementById('profile-emoji');

            // Main View
            const addFriendBtn = document.getElementById('add-friend-btn');
            const menuBtn = document.getElementById('menu-btn');
            const navHome = document.getElementById('nav-home');
            const navNotifications = document.getElementById('nav-notifications');
            const navCalls = document.getElementById('nav-calls');
            const homeContent = document.getElementById('home-content');
            const notificationsContent = document.getElementById('notifications-content');
            const callsContent = document.getElementById('calls-content'); // "ALL FRIEND" ‡¶™‡ßá‡¶ú‡ßá‡¶∞ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶•‡¶æ‡¶ï‡¶¨‡ßá
            const allNavTabs = document.querySelectorAll('.nav-tab');
            const allContentPanels = document.querySelectorAll('.content-panel');
            const chatsBadge = document.getElementById('chats-badge');
            const notificationsBadge = document.getElementById('notifications-badge');

            // Chat View
            const chatBackBtn = document.getElementById('chat-back-btn');
            const chatHeaderInfo = document.getElementById('chat-header-info');
            const chatHeaderPicWrapper = document.getElementById('chat-header-pic-wrapper'); // MODIFIED
            const chatHeaderName = document.getElementById('chat-header-name');
            const chatMoreBtn = document.getElementById('chat-more-btn');
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const chatSendBtn = document.getElementById('chat-send-btn');

            // Call Views
            const remoteVideo = document.getElementById('remote-video');
            const localVideo = document.getElementById('local-video');
            const remoteAudio = document.getElementById('remote-audio');
            const ringtone = document.getElementById('ringtone');
            
            const videoCallerPicWrapper = document.getElementById('video-caller-pic-wrapper'); // MODIFIED
            const videoCallerName = document.getElementById('video-caller-name');
            const videoEndCallBtn = document.getElementById('video-end-call-btn');
            
            const voiceCallerPicWrapper = document.getElementById('voice-caller-pic-wrapper'); // MODIFIED
            const voiceCallerName = document.getElementById('voice-caller-name');
            const voiceCallStatus = document.getElementById('voice-call-status');
            const voiceEndCallBtn = document.getElementById('voice-end-call-btn');

            // Modals Content
            const addFriendForm = document.getElementById('add-friend-form');
            const friendIdInput = document.getElementById('friend-id-input');
            
            // Profile View Refs (Updated for Pic/Name Editing)
            const profilePicWrapper = document.getElementById('profile-pic-wrapper'); // NEW
            const profileViewName = document.getElementById('profile-view-name');
            const profileViewEmail = document.getElementById('profile-view-email'); 
            const profileEditNameBtn = document.getElementById('profile-edit-name-btn'); // NEW
            const profileEditNameForm = document.getElementById('profile-edit-name-form'); // NEW
            const profileNameInput = document.getElementById('profile-name-input'); // NEW
            const profileSaveNameBtn = document.getElementById('profile-save-name-btn'); // NEW
            const profileUserIdText = document.getElementById('profile-user-id-text');
            const profileUserEmailText = document.getElementById('profile-user-email-text'); 
            const profileCopyIdBtn = document.getElementById('profile-copy-id-btn');
            const profileCopyEmailBtn = document.getElementById('profile-copy-email-btn'); 
            const blockedUsersList = document.getElementById('blocked-users-list');
            const logoutBtn = document.getElementById('logout-btn');

            const incomingCallPicWrapper = document.getElementById('incoming-call-pic-wrapper'); // MODIFIED
            const incomingCallName = document.getElementById('incoming-call-name');
            const incomingCallType = document.getElementById('incoming-call-type');
            const acceptCallBtn = document.getElementById('accept-call-btn');
            const rejectCallBtn = document.getElementById('reject-call-btn');


            // --- UTILITY FUNCTIONS ---

            /**
             * Shows a specific view and hides all others
             * @param {string} viewId - The ID of the view to show
             */
            function showView(viewId) {
                allViews.forEach(view => {
                    view.classList.toggle('hidden', view.id !== viewId);
                });
            }

            /**
             * Shows or hides a modal overlay
             * @param {string} modalId - The ID of the modal to show/hide
             * @param {boolean} [show=true] - Whether to show or hide the modal
             */
            function showModal(modalId, show = true) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.toggle('hidden', !show);
                }
            }
            
            /**
             * Shows a specific content panel in the main view
             * @param {string} panelId - The ID of the panel to show (e.g., 'home-content')
             */
            function showPanel(panelId) {
                allContentPanels.forEach(panel => {
                    panel.classList.toggle('active', panel.id === panelId);
                });
                allNavTabs.forEach(tab => {
                    tab.classList.toggle('active', tab.id === `nav-${panelId.split('-')[0]}`);
                });
            }

            /**
             * Generates a unique, sorted chat ID for two users
             * @param {string} uid1
             * @param {string} uid2
             * @returns {string} The sorted chat ID
             */
            function getChatId(uid1, uid2) {
                return uid1 < uid2 ? `${uid1}_${uid2}` : `${uid2}_${uid1}`;
            }

            /**
             * Formats a timestamp into a 12-hour time string (e.g., 1:30 PM)
             * @param {number} timestamp - The UNIX timestamp
             * @returns {string} The formatted time
             */
            function formatTimestamp(timestamp) {
                const date = new Date(timestamp);
                let hours = date.getHours();
                const minutes = date.getMinutes();
                const ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12;
                hours = hours ? hours : 12; // the hour '0' should be '12'
                const minutesStr = minutes < 10 ? '0' + minutes : minutes;
                return `${hours}:${minutesStr} ${ampm}`;
            }

            /**
             * NEW: Generates the inner HTML for a profile picture display
             * @param {object} user - The user object (must have profilePicUrl and name/uid)
             * @param {string} [placeholderSize="2.5rem"] - Font size for the placeholder
             * @returns {string} HTML string (either <img> or <span>)
             */
            function getProfilePicHTML(user, placeholderSize = '2.5rem') {
                if (user.profilePicUrl) {
                    // Use user's picture
                    return `<img src="${user.profilePicUrl}" alt="Pic">`;
                } else {
                    // Use first letter of name, or '?'
                    const name = user.name || user.uid;
                    const placeholder = name ? name.charAt(0).toUpperCase() : '?';
                    return `<span style="font-size: ${placeholderSize}; line-height: 1; user-select: none;">${placeholder}</span>`;
                }
            }


            /**
             * Cleans up all active listeners to prevent memory leaks on logout
             */
            function cleanupListeners() {
                if (currentChatListener) currentChatListener.off();
                if (requestListener) requestListener.off();
                if (callListener) callListener.off();

                Object.values(unreadListeners).forEach(listener => {
                    if (listener && typeof listener.off === 'function') {
                        listener.off();
                    }
                });
                Object.values(contactListeners).forEach(listener => {
                    if (listener && typeof listener.off === 'function') {
                        listener.off();
                    }
                });
                
                unreadListeners = {};
                contactListeners = {};
                currentChatListener = null;
                requestListener = null;
                callListener = null;
                lastMessageTimestamps = {}; // Clear sorting cache
                messageElements = {}; // Clear message element cache
            }

            /**
             * Cleans up all WebRTC and UI state after a call
             */
            function cleanupCall() {
                if (peerConnection) {
                    peerConnection.close();
                    peerConnection = null;
                }
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                    localStream = null;
                }
                remoteVideo.srcObject = null;
                localVideo.srcObject = null;
                remoteAudio.srcObject = null;
                ringtone.pause();
                
                showModal('incoming-call-modal', false);

                // MODIFIED: After a call, decide where to return
                // if (profileSetupModal.classList.contains('hidden')) { // profileSetupModal removed
                    // If user is logged in (currentUser is set), go to main-view
                    // If not, this function will be followed by showView('calculator-view') from auth state change
                    if(currentUser) {
                        showView('main-view');
                    }
                // }
                
                incomingCallData = null;
                activeCallId = null;
            }

            // --- NEW: ROBUST COPY FUNCTION (FIX FOR `file:///` PROTOCOL) ---
            /**
             * Helper function to copy text to clipboard (works in most environments)
             * @param {string} text - The text to copy
             * @param {string} message - The alert message to show on success
             */
            function copyText(text, message) {
                if (!text) return; // Don't copy if text is empty
                try {
                    // Create a temporary textarea element
                    const el = document.createElement('textarea');
                    el.value = text;
                    el.setAttribute('readonly', ''); // Make it read-only
                    el.style.position = 'absolute';
                    el.style.left = '-9999px'; // Move it off-screen
                    document.body.appendChild(el);
                    
                    // Select the text
                    const selected = document.getSelection().rangeCount > 0 
                        ? document.getSelection().getRangeAt(0) 
                        : false;
                    el.select();
                    
                    // Execute copy command
                    document.execCommand('copy');
                    
                    // Remove the temporary element
                    document.body.removeChild(el);
                    
                    // Restore original selection
                    if (selected) {
                        document.getSelection().removeAllRanges();
                        document.getSelection().addRange(selected);
                    }
                    
                    // Show success alert
                    alert(message);
                    
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    alert('Failed to copy. See console for details.');
                }
            }

            // --- *** START: NEW BACK BUTTON HANDLING *** ---
            /**
             * This function defines the custom back button logic.
             * It checks the UI state from most "deep" to most "shallow".
             * @returns {boolean} - Returns true if the back action was handled, false otherwise.
             */
            function handleCustomBack() {
                // 1. Check for open modals (highest priority)
                if (!profileViewModal.classList.contains('hidden')) {
                    showModal('profile-view-modal', false);
                    return true; // We handled it
                }
                if (!addFriendModal.classList.contains('hidden')) {
                    showModal('add-friend-modal', false);
                    return true; // We handled it
                }
                if (!incomingCallModal.classList.contains('hidden')) {
                    rejectCallBtn.click(); // Reject the call
                    return true; // We handled it
                }

                // 2. Check for open full-screen views
                if (!chatView.classList.contains('hidden')) {
                    chatBackBtn.click(); // Use existing back button logic
                    return true; // We handled it
                }
                if (!videoCallView.classList.contains('hidden')) {
                    videoEndCallBtn.click(); // End the call
                    return true; // We handled it
                }
                if (!voiceCallView.classList.contains('hidden')) {
                    voiceEndCallBtn.click(); // End the call
                    return true; // We handled it
                }
                if (!authView.classList.contains('hidden')) {
                    showView('calculator-view'); // Go from auth to calc
                    return true; // We handled it
                }

                // 3. Check for panels in main-view
                if (!mainView.classList.contains('hidden')) {
                    if (!homeContent.classList.contains('active')) {
                        // If on "Notifications" or "ALL FRIEND", go back to "Home"
                        showPanel('home-content');
                        return true; // We handled it
                    } else {
                        // We are on the main 'Home' panel. Go to calculator.
                        showView('calculator-view');
                        return true; // We handled it
                    }
                }
                
                // 4. If we are on the calculator view, we don't handle it.
                // Let the browser/app exit.
                if (!calculatorView.classList.contains('hidden')) {
                    return false; // Let default behavior (exit) happen
                }

                return false; // Default: let browser handle it
            }

            // Listen for the 'popstate' event (back button press)
            window.addEventListener('popstate', (event) => {
                // Run our custom logic
                const handled = handleCustomBack();
                
                if (handled) {
                    // If we handled the back press, we must push a new state
                    // to "re-arm" the back button listener.
                    // This prevents the app from closing on the next back press.
                    history.pushState(null, '', window.location.pathname); 
                }
                // If it was not handled (e.g., we are on the calculator),
                // we don't push a new state, allowing the default back behavior (exit).
            });

            // --- INITIAL HISTORY STATE ---
            // Push an initial state when the app loads.
            // This is the "trap" that catches the first back button press.
            history.pushState(null, '', window.location.pathname);
            // --- *** END: NEW BACK BUTTON HANDLING *** ---


            // --- NEW: PREMIUM CALCULATOR LOGIC ---

            /**
             * Helper function to update the calculator display
             * NEW: Automatically shrinks font size if number is too long
             */
            function updateCalcDisplay() {
                // Premium: shrink font size if too long
                if (calcDisplayValue.length > 9) {
                    calcDisplay.style.fontSize = '2.5rem';
                } else if (calcDisplayValue.length > 6) {
                    calcDisplay.style.fontSize = '3.5rem';
                } else {
                    calcDisplay.style.fontSize = '4.5rem';
                }
                calcDisplay.textContent = calcDisplayValue;
            }

            calcButtons.addEventListener('click', (e) => {
                const button = e.target.closest('.calc-btn');
                if (!button) return;

                const key = button.dataset.key;
                const lastChar = calcDisplayValue[calcDisplayValue.length - 1];
                const operators = ['/', '*', '-', '+'];

                if (key === 'clear') {
                    calcDisplayValue = '0';
                
                } else if (key === 'backspace') {
                    if (calcDisplayValue.length > 1) {
                        calcDisplayValue = calcDisplayValue.slice(0, -1);
                    } else {
                        calcDisplayValue = '0';
                    }

                } else if (key === '.') {
                    // Prevent multiple decimals in a row or in the same number
                    // Simple check: don't add if last char is already a dot
                    if (lastChar !== '.') {
                        calcDisplayValue += key;
                    }

                } else if (key === 'equals') {
                    
                    // --- !!! SECRET CODE CHECK !!! ---
                    if (calcDisplayValue === '59+59') {
                        calcDisplayValue = '0'; // Reset display first
                        updateCalcDisplay(); // NEW: Update display to show 0
                        
                        // --- UNLOCK LOGIC (MODIFIED) ---
                        // Wait for the auth state promise to resolve
                        authReadyPromise.then(() => {
                            // Now we are 100% sure currentUser and currentUserData are set
                            if (currentUser) {
                                // User is logged in
                                if (currentUserData) {
                                    // User is logged in AND has a profile
                                    // --- *** START: MODIFIED CODE *** ---
                                    if (appInitialized) {
                                        // App is already initialized, just show the main view
                                        showView('main-view');
                                        // Push history state to match initializeApp's behavior
                                        history.pushState(null, '', window.location.pathname);
                                    } else {
                                        // App is not initialized (e.g., first login), run the full setup
                                        initializeApp(); // This will show main-view and start listeners
                                    }
                                    // --- *** END: MODIFIED CODE *** ---
                                } else {
                                    // User is logged in but has NO profile (e.g., interrupted setup)
                                    showView('auth-view');
                                    // NEW: Push history state for auth view
                                    history.pushState(null, '', window.location.pathname);
                                }
                            } else {
                                // No user is logged in
                                showView('auth-view');
                                // NEW: Push history state for auth view
                                history.pushState(null, '', window.location.pathname);
                            }
                        });
                        
                    } else {
                        // Perform normal calculation
                        try {
                            // Replace visual operators with code operators
                            let expression = calcDisplayValue
                                .replace(/√ó/g, '*')
                                .replace(/√∑/g, '/')
                                .replace(/‚àí/g, '-');
                            
                            // Prevent trailing operators
                            if (operators.includes(expression[expression.length - 1])) {
                                expression = expression.slice(0, -1);
                            }

                            const result = new Function('return ' + expression)();
                            // Format result: round to 4 decimal places
                            calcDisplayValue = String(Number(result.toFixed(4)));
                        } catch (err) {
                            calcDisplayValue = 'Error';
                        }
                    }

                } else if (operators.includes(key)) {
                    // Prevent stacking operators like "5++" or "5+-"
                    if (operators.includes(lastChar)) {
                        // Replace last operator
                        calcDisplayValue = calcDisplayValue.slice(0, -1) + key;
                    } else {
                        calcDisplayValue += key;
                    }

                } else {
                    // It's a number key
                    if (calcDisplayValue === '0' || calcDisplayValue === 'Error') {
                        calcDisplayValue = key;
                    } else {
                        calcDisplayValue += key;
                    }
                }

                // Update display
                updateCalcDisplay();
            });


            // --- AUTHENTICATION ---

            // --- NEW: SET AUTH PERSISTENCE AND WRAP LISTENER ---
            // This ensures the user stays logged in (Persistence.LOCAL)
            auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                .then(() => {
                    // Persistence set. Now, attach the onAuthStateChanged listener.
                    initializeAuthListener();
                })
                .catch((error) => {
                    console.error("Error setting auth persistence: ", error);
                    // Still initialize listener, but log the error
                    initializeAuthListener();
                });

            // MODIFIED: This function now ONLY sets user data.
            // It NO LONGER changes the view, allowing the calculator to stay on top.
            // It's wrapped in a function to be called *after* persistence is set.
            function initializeAuthListener() {
                auth.onAuthStateChanged(user => {
                    cleanupListeners();
                    if (user) {
                        currentUser = user;
                        // Check if user has a profile
                        db.ref('users/' + user.uid).once('value', snapshot => {
                            if (snapshot.exists()) {
                                currentUserData = snapshot.val();
                                
                                // --- NEW: START LISTENING FOR UNREADS IMMEDIATELY ---
                                // This will update the badge on the calculator view
                                // even before the app is "unlocked".
                                listenForUnreadCounts(); 
                                // --- END NEW ---
                                
                            } else {
                                // New user, but no profile.
                                currentUserData = null; // Mark as null
                                // The unlock logic will handle showing the profile setup modal.
                            }

                            // --- NEW: Resolve auth promise ---
                            if (!authStateInitialized) {
                                authStateInitialized = true;
                                authStateResolve(); // Resolve the promise
                            }
                        });
                    } else {
                        // User is logged out
                        currentUser = null;
                        currentUserData = null;
                        appInitialized = false; // <<< MODIFICATION: Reset app state on logout
                        cleanupCall(); // Ensure call state is cleared on logout
                        
                        // --- MODIFIED: Only show calc view on explicit logout ---
                        // This prevents a flash of the calc view on reload when logged in
                        if (authStateInitialized) {
                            showView('calculator-view');
                        }
                        
                        // --- NEW: HIDE BADGE ON LOGOUT ---
                        if (calcNotificationBadge) {
                            calcNotificationBadge.classList.add('hidden');
                            calcNotificationBadge.textContent = '0'; // Reset text
                        }
                        // --- END NEW ---
                        
                        // --- NEW: Resolve auth promise ---
                        if (!authStateInitialized) {
                            authStateInitialized = true;
                            authStateResolve(); // Resolve promise even if logged out
                        }
                    }
                });
            }
            // --- END OF NEW/MODIFIED AUTH SECTION ---


            // Login (FIXED)
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                loginError.textContent = ''; // Clear previous errors
                const email = loginForm['login-email'].value;
                const password = loginForm['login-password'].value;
                
                auth.signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        // Login was successful. onAuthStateChanged will fire to set state,
                        // but we need to *proactively* change the view here.
                        const user = userCredential.user;
                        
                        // We must check if they have a profile, just like onAuthStateChanged does.
                        db.ref('users/' + user.uid).once('value', snapshot => {
                            if (snapshot.exists()) {
                                // User has a profile, initialize the app
                                currentUserData = snapshot.val(); // Ensure data is set
                                initializeApp(); // This shows main-view
                            } else {
                                // User is new or profile setup was interrupted.
                                // MODIFIED: Don't show modal. This case should ideally not happen
                                // if signup is correct. We'll just stay on auth-view.
                                loginError.textContent = "Profile data not found. Please contact support.";
                            }
                        });
                    })
                    .catch(error => {
                        loginError.textContent = error.message;
                    });
            });

            // Signup (MODIFIED)
            signupForm.addEventListener('submit', (e) => {
                e.preventDefault();
                signupError.textContent = ''; // Clear previous errors
                const email = signupForm['signup-email'].value;
                const password = signupForm['signup-password'].value;
                
                auth.createUserWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        // Signup was successful.
                        // MODIFIED: Create a default profile automatically
                        const user = userCredential.user;
                        const defaultProfile = {
                            uid: user.uid,
                            email: user.email,
                            name: user.uid, // Default name is UID as requested
                            profilePicUrl: "", // Default is no picture
                            blocked: {}
                        };

                        db.ref('users/' + user.uid).set(defaultProfile)
                            .then(() => {
                                // Profile created. Now, show login form.
                                loginForm.classList.remove('hidden');
                                signupForm.classList.add('hidden');
                                alert('Signup successful! Please log in.');
                            })
                            .catch(error => {
                                signupError.textContent = "Signup OK, but failed to create profile: " + error.message;
                            });
                    })
                    .catch(error => {
                        signupError.textContent = error.message;
                    });
            });


            // Logout
            logoutBtn.addEventListener('click', () => {
                appInitialized = false; // <<< MODIFICATION: Reset app state on logout
                auth.signOut();
                showModal('profile-view-modal', false);
                // onAuthStateChanged will handle switching to calculator-view
            });

            // Toggle auth forms
            showSignupBtn.addEventListener('click', () => {
                    loginForm.classList.add('hidden');
                    signupForm.classList.remove('hidden');
            });
            showLoginBtn.addEventListener('click', () => {
                loginForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
            });


            // --- PROFILE MANAGEMENT ---

            // REMOVED: profileSetupForm event listener

            // --- Show Profile Modal ---
            menuBtn.addEventListener('click', () => {
                if (!currentUserData) return;
                
                // MODIFIED: Use getProfilePicHTML
                profilePicWrapper.innerHTML = getProfilePicHTML(currentUserData, '4.5rem');
                profileViewName.textContent = currentUserData.name;
                profileViewEmail.textContent = currentUserData.email; // Display email
                profileUserIdText.textContent = currentUserData.uid; 
                profileUserEmailText.textContent = currentUserData.email; // Display email in the frame
                
                // Populate blocked users
                blockedUsersList.innerHTML = '';
                if (currentUserData.blocked && Object.keys(currentUserData.blocked).length > 0) {
                    Object.keys(currentUserData.blocked).forEach(uid => {
                        db.ref('users/' + uid).once('value', snapshot => {
                            if (snapshot.exists()) {
                                const user = snapshot.val();
                                const item = document.createElement('div');
                                item.className = 'blocked-user-item';
                                item.innerHTML = `
                                    <span>${getProfilePicHTML(user, '1.5rem')} ${user.name}</span>
                                    <button class="unblock-btn" data-uid="${user.uid}">Unblock</button>
                                `;
                                blockedUsersList.appendChild(item);
                            }
                        });
                    });
                } else {
                    blockedUsersList.innerHTML = '<p style="padding: 8px; text-align: center;">No blocked users.</p>';
                }

                // NEW: Ensure edit form is hidden on modal open
                profileEditNameForm.classList.add('hidden');
                profileViewName.classList.remove('hidden');
                profileEditNameBtn.classList.remove('hidden');

                showModal('profile-view-modal');
                // NEW: Push history state for modal
                history.pushState(null, '', window.location.pathname);
            });

            // --- NEW: Profile Pic Click Listener ---
            profilePicWrapper.addEventListener('click', () => {
                const url = prompt('Enter new profile picture URL:', currentUserData.profilePicUrl || '');
                if (url !== null) { // User didn't click cancel
                    // Basic URL validation (optional but good)
                    if (url === '' || (url.startsWith('http://') || url.startsWith('https://'))) {
                        db.ref(`users/${currentUser.uid}/profilePicUrl`).set(url)
                            .then(() => {
                                currentUserData.profilePicUrl = url;
                                // Refresh display
                                profilePicWrapper.innerHTML = getProfilePicHTML(currentUserData, '4.5rem');
                                alert('Profile picture updated!');
                            })
                            .catch(err => alert('Error: ' + err.message));
                    } else {
                        alert('Invalid URL. Must start with http:// or https://, or be empty.');
                    }
                }
            });

            // --- NEW: Profile Name Edit Listeners ---
            profileEditNameBtn.addEventListener('click', () => {
                profileEditNameForm.classList.remove('hidden');
                profileNameInput.value = currentUserData.name;
                profileViewName.classList.add('hidden');
                profileEditNameBtn.classList.add('hidden');
            });

            profileSaveNameBtn.addEventListener('click', () => {
                const newName = profileNameInput.value.trim();
                if (newName && newName !== currentUserData.name) {
                    db.ref(`users/${currentUser.uid}/name`).set(newName)
                        .then(() => {
                            currentUserData.name = newName;
                            profileViewName.textContent = newName;
                            alert('Name updated!');
                            
                            // Also update placeholder if no pic
                            if (!currentUserData.profilePicUrl) {
                                profilePicWrapper.innerHTML = getProfilePicHTML(currentUserData, '4.5rem');
                            }
                        })
                        .catch(err => alert('Error: ' + err.message))
                        .finally(() => {
                            // Hide form, show name
                            profileEditNameForm.classList.add('hidden');
                            profileViewName.classList.remove('hidden');
                            profileEditNameBtn.classList.remove('hidden');
                        });
                } else {
                    // No change, just hide form
                    profileEditNameForm.classList.add('hidden');
                    profileViewName.classList.remove('hidden');
                    profileEditNameBtn.classList.remove('hidden');
                }
            });


            // --- Copy User ID ---
            profileCopyIdBtn.addEventListener('click', () => {
                copyText(currentUserData.uid, 'User ID copied to clipboard!');
            });

            // --- Copy User Email ---
            profileCopyEmailBtn.addEventListener('click', () => {
                copyText(currentUserData.email, 'Email copied to clipboard!');
            });

            // Handle unblocking
            blockedUsersList.addEventListener('click', (e) => {
                if (e.target.classList.contains('unblock-btn')) {
                    const uidToUnblock = e.target.dataset.uid;
                    unblockUser(uidToUnblock);
                }
            });

            // Close modal buttons
            document.querySelectorAll('.close-modal-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const modal = e.target.closest('.modal');
                    if (modal) {
                        showModal(modal.id, false);
                        // NEW: Manually go back in history to sync state
                        // This is a simple way to handle modal close
                        if (history.state) {
                            history.back();
                        }
                    }
                });
            });


            // --- APP INITIALIZATION ---

            /**
             * This function is now ONLY called after a successful unlock.
             */
            function initializeApp() {
                showView('main-view');
                showPanel('home-content');
                
                // NEW: Push history state for main view
                history.pushState(null, '', window.location.pathname);
                
                // Start all listeners now that we are in the app
                listenForContacts(); // "CHATS" ‡¶™‡ßá‡¶ú ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶¨‡ßá
                listenForFriendRequests();
                // listenForUnreadCounts(); // REMOVED: Now starts on auth state change
                listenForIncomingCalls();
                listenForAllFriends(); // NEW: "ALL FRIEND" ‡¶™‡ßá‡¶ú ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶¨‡ßá
                
                appInitialized = true; // <<< MODIFICATION: Set flag that app is initialized
            }


            // --- FRIEND & CONTACT SYSTEM ---

            // Show "Add Friend" modal
            addFriendBtn.addEventListener('click', () => {
                addFriendForm.reset();
                showModal('add-friend-modal');
                // NEW: Push history state for modal
                history.pushState(null, '', window.location.pathname);
            });

            // Handle "Add Friend" form submission
            addFriendForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const friendId = friendIdInput.value.trim();

                if (friendId === currentUser.uid) {
                    alert("You can't add yourself as a friend.");
                    return;
                }
                
                if (currentUserData.blocked && currentUserData.blocked[friendId]) {
                    alert("You have blocked this user. Unblock them to send a request.");
                    return;
                }

                // Check if user exists
                db.ref('users/' + friendId).once('value', snapshot => {
                    if (snapshot.exists()) {
                        const recipient = snapshot.val();
                        // Check if recipient has blocked current user
                        if (recipient.blocked && recipient.blocked[currentUser.uid]) {
                            alert("This user is not accepting friend requests.");
                            return;
                        }

                        // Create request
                        const requestRef = db.ref(`requests/${friendId}/${currentUser.uid}`);
                        // MODIFIED: Send name and profilePicUrl instead of emoji
                        requestRef.set({
                            fromUid: currentUser.uid,
                            fromName: currentUserData.name,
                            fromProfilePicUrl: currentUserData.profilePicUrl || "", 
                            timestamp: firebase.database.ServerValue.TIMESTAMP
                        }).then(() => {
                            alert('Friend request sent!');
                            showModal('add-friend-modal', false);
                            // NEW: Go back in history to sync
                            if(history.state) history.back();
                        });
                    } else {
                        alert('User not found.');
                    }
                });
            });

            // Listen for new friend requests
            function listenForFriendRequests() {
                if (requestListener) requestListener.off();
                requestListener = db.ref('requests/' + currentUser.uid);
                
                requestListener.on('value', snapshot => {
                    notificationsContent.innerHTML = ''; // Clear list
                    let requestCount = 0;
                    if (snapshot.exists()) {
                        snapshot.forEach(childSnapshot => {
                            const request = childSnapshot.val();
                            
                            // Don't show requests from users we've blocked
                            if (currentUserData.blocked && currentUserData.blocked[request.fromUid]) {
                                return;
                            }
                            
                            requestCount++;
                            const item = document.createElement('div');
                            item.className = 'list-item';
                            // MODIFIED: Use getProfilePicHTML
                            item.innerHTML = `
                                <div class="item-emoji">
                                ${getProfilePicHTML({name: request.fromName, profilePicUrl: request.fromProfilePicUrl})}
                                </div>
                                <div class="item-details">
                                    <div class="item-name">${request.fromName}</div>
                                    <div class="item-subtext">Wants to be your contact.</div>
                                    <div class="notification-actions">
                                        <button class="notif-btn reject" data-uid="${request.fromUid}">Reject</button>
                                        <button class="notif-btn accept" data-uid="${request.fromUid}">Accept</button>
                                    </div>
                                </div>
                            `;
                            notificationsContent.appendChild(item);
                        });
                    }
                    
                    if (requestCount === 0) {
                        notificationsContent.innerHTML = '<p style="padding: 20px; text-align: center; color: var(--wa-text-secondary);">No new updates.</p>';
                    }

                    // Update badge
                    notificationsBadge.textContent = requestCount;
                    notificationsBadge.classList.toggle('hidden', requestCount === 0);
                });
            }

            // Handle Accept/Reject buttons in notifications
            notificationsContent.addEventListener('click', (e) => {
                const uid = e.target.dataset.uid;
                if (!uid) return;

                if (e.target.classList.contains('accept')) {
                    acceptRequest(uid);
                } else if (e.target.classList.contains('reject')) {
                    rejectRequest(uid);
                }
            });

            function acceptRequest(senderId) {
                const myUid = currentUser.uid;
                const updates = {};
                updates[`contacts/${myUid}/${senderId}`] = true;
                updates[`contacts/${senderId}/${myUid}`] = true;
                updates[`requests/${myUid}/${senderId}`] = null; // Delete request

                db.ref().update(updates)
                    .then(() => console.log('Friend request accepted.'))
                    .catch(err => console.error('Error accepting request:', err));
            }

            function rejectRequest(senderId) {
                db.ref(`requests/${currentUser.uid}/${senderId}`).remove()
                    .then(() => console.log('Friend request rejected.'))
                    .catch(err => console.error('Error rejecting request:', err));
            }

            // Function to re-sort the chat list
            function sortChatList() {
                const chatItems = Array.from(homeContent.querySelectorAll('.list-item'));
                
                chatItems.sort((a, b) => {
                    const uidA = a.dataset.uid;
                    const uidB = b.dataset.uid;
                    
                    // Sort by last message timestamp (most recent first)
                    const timeA = lastMessageTimestamps[uidA] || 0;
                    const timeB = lastMessageTimestamps[uidB] || 0;
                    
                    return timeB - timeA;
                });

                // Re-append in sorted order
                chatItems.forEach(item => homeContent.appendChild(item));

                // --- Handle "No active chats" message ---
                const noChatsMsgId = 'no-chats-message';
                let noChatsMsg = homeContent.querySelector(`#${noChatsMsgId}`);
                
                // ‡¶∏‡¶¨ ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶π‡¶æ‡¶á‡¶° ‡¶ï‡¶∞‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶¨‡¶æ ‡¶ï‡ßã‡¶®‡ßã ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá
                const allHiddenOrEmpty = chatItems.length === 0 || chatItems.every(item => item.classList.contains('hidden'));
                
                if (allHiddenOrEmpty && !noChatsMsg) {
                    // Add message
                    noChatsMsg = document.createElement('p');
                    noChatsMsg.id = noChatsMsgId;
                    noChatsMsg.style.padding = '20px';
                    noChatsMsg.style.textAlign = 'center';
                    noChatsMsg.style.color = 'var(--wa-text-secondary)';
                    noChatsMsg.textContent = 'No active chats. Start a new one from the "ALL FRIEND" tab.';
                    homeContent.appendChild(noChatsMsg);
                } else if (!allHiddenOrEmpty && noChatsMsg) {
                    // Remove message
                    noChatsMsg.remove();
                }
            }

            /**
             * MODIFIED: Populates "CHATS" page (home-content)
             * Only shows contacts that have an active chat history.
             */
            function listenForContacts() {
                if (contactListeners.main) contactListeners.main.off();
                
                contactListeners.main = db.ref('contacts/' + currentUser.uid);
                
                // Clear all contact listeners (sub-listeners for profile/last message)
                Object.keys(contactListeners).filter(key => key !== 'main' && key !== 'allFriends').forEach(key => {
                    if (contactListeners[key] && typeof contactListeners[key].off === 'function') {
                        contactListeners[key].off();
                    }
                });
                
                homeContent.innerHTML = '<p style="padding: 20px; text-align: center; color: var(--wa-text-secondary);">Loading contacts...</p>'; // Show loading
                lastMessageTimestamps = {}; // Reset timestamps

                contactListeners.main.on('value', snapshot => {
                    const currentUids = new Set(Array.from(homeContent.querySelectorAll('.list-item')).map(el => el.dataset.uid));
                    const newUids = new Set();
                    let contactPromises = [];
                    
                    if (snapshot.exists()) {
                        snapshot.forEach(childSnapshot => {
                            const contactId = childSnapshot.key;
                            newUids.add(contactId); // Add all contacts to check for removal
                            
                            // Don't show blocked users in chat list
                            if (currentUserData.blocked && currentUserData.blocked[contactId]) {
                                const existingItem = homeContent.querySelector(`.list-item[data-uid="${contactId}"]`);
                                if(existingItem) existingItem.remove();
                                return;
                            }
                            
                            // Check if item already exists
                            let existingItem = homeContent.querySelector(`.list-item[data-uid="${contactId}"]`);

                            if (!existingItem) {
                                // Item doesn't exist, create it (it will be hidden by default)
                                contactPromises.push(db.ref('users/' + contactId).once('value').then(userSnapshot => {
                                    if (userSnapshot.exists()) {
                                        const contact = userSnapshot.val();
                                        
                                        if(contact.blocked && contact.blocked[currentUser.uid]) return null;
                                        
                                        const item = document.createElement('div');
                                        item.className = 'list-item hidden'; // --- START AS HIDDEN ---
                                        item.dataset.uid = contact.uid;
                                        // MODIFIED: Use getProfilePicHTML
                                        item.innerHTML = `
                                            <div class="item-emoji">${getProfilePicHTML(contact)}</div>
                                            <div class="item-details">
                                                <div class="item-name">${contact.name}</div>
                                                <div class="item-subtext" id="subtext-${contact.uid}">Tap to chat</div>
                                            </div>
                                            <div class="item-actions">
                                                <span class="badge hidden" id="badge-${contact.uid}"></span>
                                            </div>
                                            <div class="delete-overlay">
                                                <button class="delete-button" data-uid="${contact.uid}">Delete Chat</button>
                                                <button class="cancel-delete-button" data-uid="${contact.uid}">Cancel</button>
                                            </div>
                                        `;
                                        
                                        // Add click listener to open chat
                                        item.addEventListener('click', (e) => {
                                            if (!item.classList.contains('deleting') && !e.target.closest('.delete-button') && !e.target.closest('.cancel-delete-button')) {
                                                openChat(contact);
                                            }
                                        });

                                        // Add long-press listener
                                        let timer;
                                        item.addEventListener('mousedown', (e) => {
                                            if (e.button !== 0 || e.target.closest('.delete-overlay')) return;
                                            timer = setTimeout(() => {
                                                document.querySelectorAll('.list-item.deleting').forEach(li => {
                                                    if (li !== item) li.classList.remove('deleting');
                                                });
                                                item.classList.add('deleting');
                                            }, 500); 
                                        });
                                        item.addEventListener('touchstart', (e) => {
                                            if (e.target.closest('.delete-overlay')) return;
                                            timer = setTimeout(() => {
                                                document.querySelectorAll('.list-item.deleting').forEach(li => {
                                                    if (li !== item) li.classList.remove('deleting');
                                                });
                                                item.classList.add('deleting');
                                            }, 500);
                                        });
                                        item.addEventListener('mouseup', () => clearTimeout(timer));
                                        item.addEventListener('mouseleave', () => clearTimeout(timer));
                                        item.addEventListener('touchend', () => clearTimeout(timer));
                                        item.addEventListener('touchcancel', () => clearTimeout(timer));

                                        // --- CHANGED: Call deleteChatHistory ---
                                        item.querySelector('.delete-button').addEventListener('click', (e) => {
                                            e.stopPropagation(); 
                                            deleteChatHistory(contact.uid); // ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá
                                        });

                                        item.querySelector('.cancel-delete-button').addEventListener('click', (e) => {
                                            e.stopPropagation();
                                            item.classList.remove('deleting');
                                        });

                                        // Set up last message listener (this will un-hide if messages exist)
                                        listenForLastMessage(contact.uid);

                                        return item;
                                    }
                                    return null;
                                }));
                            } else {
                                // Item already exists, ensure listener is active
                                listenForLastMessage(contactId);
                                // NEW: Update pic and name in case they changed
                                db.ref('users/' + contactId).once('value').then(userSnapshot => {
                                    if(userSnapshot.exists()) {
                                        const contact = userSnapshot.val();
                                        const itemEmoji = existingItem.querySelector('.item-emoji');
                                        const itemName = existingItem.querySelector('.item-name');
                                        if(itemEmoji) itemEmoji.innerHTML = getProfilePicHTML(contact);
                                        if(itemName) itemName.textContent = contact.name;
                                    }
                                });
                            }
                        });
                    }

                    // Remove contacts that no longer exist (e.g., deleted by other user)
                    currentUids.forEach(uid => {
                        if (!newUids.has(uid)) {
                            homeContent.querySelector(`.list-item[data-uid="${uid}"]`).remove();
                            if (contactListeners[uid]) {
                                contactListeners[uid].off();
                                delete contactListeners[uid];
                            }
                            delete lastMessageTimestamps[uid];
                        }
                    });

                    // --- *** START: FIXED CODE *** ---
                    Promise.all(contactPromises).then(items => {
                        if (homeContent.innerHTML.includes('Loading contacts')) homeContent.innerHTML = ''; 

                        const validItems = items.filter(item => item !== null);
                        
                        // If no new items were created, just sort (to show "No chats")
                        if (validItems.length === 0) {
                            sortChatList();
                            return;
                        }
            
                        let checkedCount = 0; // Counter to know when all checks are done
            
                        validItems.forEach(item => {
                            // Add the item to the DOM first (it's still hidden)
                            homeContent.appendChild(item);
                            
                            // --- NEW INITIAL STATE CHECK ---
                            // Now that the item is in the DOM, check for existing messages
                            const contactId = item.dataset.uid;
                            const chatId = getChatId(currentUser.uid, contactId);
                            
                            db.ref('messages/' + chatId).limitToLast(1).once('value', snapshot => {
                                if (snapshot.exists()) {
                                    let latestMsg = null;
                                    snapshot.forEach(child => { latestMsg = child.val(); }); // Get the last message
                                    
                                    if (latestMsg) {
                                        // Update timestamp for sorting
                                        lastMessageTimestamps[contactId] = latestMsg.timestamp;
                                        
                                        // Update the subtext
                                        const subtextEl = document.getElementById(`subtext-${contactId}`);
                                        if (subtextEl) {
                                            const sender = latestMsg.senderId === currentUser.uid ? 'You: ' : '';
                                            subtextEl.textContent = `${sender}${latestMsg.text}`;
                                        }
                                        
                                        // Show the item
                                        item.classList.remove('hidden');
                                    }
                                } else {
                                    // No messages exist
                                    lastMessageTimestamps[contactId] = 0;
                                    // Item remains hidden by default
                                }
                                
                                // --- SORTING LOGIC ---
                                // Increment counter
                                checkedCount++;
                                // If this is the last item we've checked, sort the whole list
                                if (checkedCount === validItems.length) {
                                    sortChatList();
                                }
                            });
                            // --- END NEW INITIAL STATE CHECK ---
                        });
                    });
                    // --- *** END: FIXED CODE *** ---
                });
            }

            /**
             * NEW: Populates "ALL FRIEND" page (calls-content)
             * Shows ALL contacts, regardless of chat history.
             */
            function listenForAllFriends() {
                const allFriendsList = document.getElementById('calls-content'); // This is the 'ALL FRIEND' panel
                
                if (contactListeners.allFriends) contactListeners.allFriends.off();
                
                const contactsRef = db.ref('contacts/' + currentUser.uid);
                contactListeners.allFriends = contactsRef; // Store listener
                
                contactsRef.on('value', snapshot => {
                    allFriendsList.innerHTML = ''; // Clear on update
                    let friendCount = 0;
                    
                    if (snapshot.exists()) {
                        snapshot.forEach(childSnapshot => {
                            const contactId = childSnapshot.key;
                            
                            // Don't show blocked users
                            if (currentUserData.blocked && currentUserData.blocked[contactId]) {
                                return;
                            }
                            
                            friendCount++;
                            // Get user data
                            db.ref('users/' + contactId).once('value', userSnapshot => {
                                if (userSnapshot.exists()) {
                                    const contact = userSnapshot.val();
                                    
                                    // Don't show if they blocked us
                                    if(contact.blocked && contact.blocked[currentUser.uid]) return;
                                    
                                    const item = document.createElement('div');
                                    item.className = 'list-item'; // Reuse list-item style
                                    item.dataset.uid = contact.uid;
                                    
                                    // MODIFIED: Use getProfilePicHTML
                                    item.innerHTML = `
                                        <div class="item-emoji">${getProfilePicHTML(contact)}</div>
                                        <div class="item-details">
                                            <div class="item-name">${contact.name}</div>
                                        </div>
                                    `;
                                    
                                    // Add click listener to open chat
                                    item.addEventListener('click', () => {
                                        openChat(contact);
                                    });
                                    
                                    allFriendsList.appendChild(item);
                                }
                            });
                        });
                    }
                    
                    if (friendCount === 0) {
                        allFriendsList.innerHTML = '<p style="padding: 20px; text-align: center; color: var(--wa-text-secondary);">No friends found. Add friends using the button above.</p>';
                    }
                });
            }


            /**
             * CHANGED: This function only deletes chat history, NOT the contact.
             */
            function deleteChatHistory(partnerId) {
                const myUid = currentUser.uid;
                const updates = {};
                const chatId = getChatId(myUid, partnerId);
                
                // 1. Delete chat history
                updates[`messages/${chatId}`] = null; 
                
                // 2. Clear unread counts
                updates[`unreadCounts/${myUid}/${partnerId}`] = null;
                updates[`unreadCounts/${partnerId}/${myUid}`] = null;

                db.ref().update(updates)
                    .then(() => {
                        // The listenForLastMessage listener will automatically hide
                        // the chat from the "CHATS" list.
                        console.log('Chat history deleted.');
                    })
                    .catch(err => {
                        alert(`Error deleting chat: ${err.message}`);
                        console.error('Error deleting chat history:', err);
                    });
            }
            
            /**
             * MODIFIED: Hides/Shows item based on message existence.
             */
            function listenForLastMessage(contactId) {
                const chatId = getChatId(currentUser.uid, contactId);
                const subtextEl = document.getElementById(`subtext-${contactId}`);
                
                if (contactListeners[contactId]) {
                    contactListeners[contactId].off();
                }
                
                const messagesRef = db.ref('messages/' + chatId).limitToLast(1);
                contactListeners[contactId] = messagesRef;
                
                // --- *** START: MODIFIED CODE *** ---
                // This listener will now primarily handle *new* messages
                // that arrive *after* the initial load.
                messagesRef.on('child_added', snapshot => {
                    const msg = snapshot.val();
                    // This check ensures the element exists *before* trying to update it
                    const item = homeContent.querySelector(`.list-item[data-uid="${contactId}"]`);
                    if (item) { 
                        if (subtextEl) {
                            const sender = msg.senderId === currentUser.uid ? 'You: ' : '';
                            subtextEl.textContent = `${sender}${msg.text}`;
                        }
                        lastMessageTimestamps[contactId] = msg.timestamp;
                        
                        // --- SHOW ITEM ---
                        item.classList.remove('hidden'); 
                        sortChatList();
                    }
                });
                // --- *** END: MODIFIED CODE *** ---
                
                messagesRef.on('child_removed', () => {
                    // Check if *any* messages are left
                    db.ref('messages/' + chatId).once('value', snapshot => {
                        const item = homeContent.querySelector(`.list-item[data-uid="${contactId}"]`);
                        if (!snapshot.exists()) {
                            // All messages are gone
                            if (subtextEl) {
                                subtextEl.textContent = 'Tap to chat';
                            }
                            lastMessageTimestamps[contactId] = 0; // Reset timestamp
                            
                            // --- HIDE ITEM ---
                            if(item) item.classList.add('hidden');
                            
                            sortChatList();
                        }
                    });
                });
                
                // --- *** DELETED THE .once('value') BLOCK FROM HERE *** ---
                // The initial check is now done in listenForContacts()
            }


            // --- MAIN VIEW NAVIGATION ---
            allNavTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const panelId = `${tab.id.split('-')[1]}-content`;
                    showPanel(panelId);
                    // NEW: Push history state for panel change
                    history.pushState(null, '', window.location.pathname);
                });
            });


            // --- MESSAGING ---

            function openChat(partner) {
                currentChatPartner = partner;
                
                // Populate chat header
                // MODIFIED: Use getProfilePicHTML
                chatHeaderPicWrapper.innerHTML = getProfilePicHTML(partner, '1.8rem');
                chatHeaderName.textContent = partner.name;
                
                // Clear old messages and show chat view
                chatMessages.innerHTML = '';
                messageElements = {}; // Clear message element cache
                showView('chat-view');

                // NEW: Push history state for chat view
                history.pushState(null, '', window.location.pathname);

                // Clear unread count for this chat
                db.ref(`unreadCounts/${currentUser.uid}/${partner.uid}`).remove();

                // Listen for messages
                const chatId = getChatId(currentUser.uid, partner.uid);
                if (currentChatListener) {
                    currentChatListener.off(); // Stop listening to previous chat
                }
                // Load initial 50 messages and set up continuous listening
                const messagesRef = db.ref('messages/' + chatId);
                currentChatListener = messagesRef.limitToLast(50);
                
                currentChatListener.on('child_added', snapshot => {
                    const msg = snapshot.val();
                    renderMessage(snapshot.key, msg);
                    
                    // NEW: Mark received messages as 'seen'
                    if (msg.receiverId === currentUser.uid && msg.status !== 'seen') {
                        messagesRef.child(snapshot.key).update({ status: 'seen' });
                    }
                });
                
                // NEW: Listen for status changes (e.g., sent -> seen)
                messagesRef.on('child_changed', snapshot => {
                    const msg = snapshot.val();
                    // Only update status for messages *we* sent to the current partner
                    if (msg.senderId === currentUser.uid && msg.receiverId === partner.uid && messageElements[snapshot.key]) {
                        updateMessageStatus(snapshot.key, msg.status);
                    }
                });
            }

            // NEW: SVG for status icons
            function getStatusSVG(status) {
                const baseClass = 'message-status-icon';
                const isSeen = status === 'seen';
                const fill = isSeen ? 'var(--wa-accent-blue)' : 'var(--wa-text-secondary)';
                const svgPath = isSeen
                    ? 'M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z' // Double Checkmark (Seen)
                    : 'M9.01 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9.01 16.2zm7-9.9l1.4 1.4L9 16.2l-1.4-1.4L9 13.4l7-7z'; // Single Checkmark (Sent)

                return `
                    <svg class="${baseClass} ${isSeen ? 'seen' : ''}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${fill}">
                        <path d="${svgPath}"/>
                    </svg>
                `;
            }

            function renderMessage(msgId, msg) {
                const isSent = msg.senderId === currentUser.uid;
                
                // If message already exists, don't re-render, just cache its ID
                if (messageElements[msgId]) return;
                
                const bubble = document.createElement('div');
                bubble.className = `message-bubble ${isSent ? 'message-sent' : 'message-received'}`;
                bubble.id = `msg-${msgId}`;
                
                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'message-content-wrapper';
                
                const textSpan = document.createElement('span');
                textSpan.className = 'message-text';
                textSpan.textContent = msg.text;
                
                const timeStatusWrapper = document.createElement('div');
                timeStatusWrapper.className = 'message-time-status';

                const timeSpan = document.createElement('span');
                timeSpan.textContent = formatTimestamp(msg.timestamp);

                timeStatusWrapper.appendChild(timeSpan);
                
                // Only show status icon for sent messages
                if (isSent) {
                    const statusIconWrapper = document.createElement('span');
                    statusIconWrapper.id = `status-${msgId}`;
                    statusIconWrapper.innerHTML = getStatusSVG(msg.status || 'sent'); // Default to 'sent'
                    timeStatusWrapper.appendChild(statusIconWrapper);
                }
                
                contentWrapper.appendChild(textSpan);
                contentWrapper.appendChild(timeStatusWrapper);
                bubble.appendChild(contentWrapper);
                
                chatMessages.appendChild(bubble);
                messageElements[msgId] = bubble; // Cache the element

                // Scroll to bottom only if the user is already near the bottom
                if (chatMessages.scrollHeight - chatMessages.clientHeight <= chatMessages.scrollTop + 100) {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            }

            // NEW: Function to update only the status icon
            function updateMessageStatus(msgId, newStatus) {
                const statusEl = document.getElementById(`status-${msgId}`);
                if (statusEl) {
                    statusEl.innerHTML = getStatusSVG(newStatus);
                }
            }

            // Send Message
            chatSendBtn.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            function sendMessage() {
                const text = chatInput.value.trim();
                if (text === '' || !currentChatPartner) return;
                
                const chatId = getChatId(currentUser.uid, currentChatPartner.uid);
                const message = {
                    text: text,
                    senderId: currentUser.uid,
                    receiverId: currentChatPartner.uid,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    status: 'sent' // NEW: Message status
                };
                
                // Push message to DB
                db.ref('messages/' + chatId).push(message);
                
                // Update receiver's unread count
                const unreadRef = db.ref(`unreadCounts/${currentChatPartner.uid}/${currentUser.uid}`);
                unreadRef.transaction(count => (count || 0) + 1);

                chatInput.value = '';
            }

            // Chat back button
            chatBackBtn.addEventListener('click', () => {
                showView('main-view');
                currentChatPartner = null;
                if (currentChatListener) {
                    currentChatListener.off();
                    currentChatListener = null;
                }
                // NEW: Manually go back in history to sync state
                // This is not strictly needed if popstate handles it, but good for consistency
                if (history.state) {
                    // history.back(); // This might be handled by the popstate itself
                }
            });

            // Listen for unread counts for all contacts
            function listenForUnreadCounts() {
                const myUid = currentUser.uid;
                
                // Stop all previous listeners
                if(unreadListeners.main) unreadListeners.main.off();

                // We need to listen to our "unread" node
                const unreadRoot = db.ref('unreadCounts/' + myUid);
                
                unreadRoot.on('value', snapshot => {
                    let totalUnread = 0;
                    const counts = snapshot.val() || {};
                    
                    // Update badges for each contact
                    document.querySelectorAll('.list-item').forEach(item => {
                        const uid = item.dataset.uid;
                        if (uid) {
                            const badge = document.getElementById(`badge-${uid}`);
                            const count = counts[uid] || 0;
                            if (badge) {
                                badge.textContent = count;
                                badge.classList.toggle('hidden', count === 0);
                            }
                        }
                    });
                    
                    // Update total chats badge
                    totalUnread = Object.values(counts).reduce((sum, count) => sum + count, 0);
                    chatsBadge.textContent = totalUnread;
                    chatsBadge.classList.toggle('hidden', totalUnread === 0);
                    
                    // --- NEW: UPDATE CALCULATOR BADGE ---
                    if (calcNotificationBadge) {
                        calcNotificationBadge.textContent = totalUnread;
                        // Use toggle with 'hidden' class
                        calcNotificationBadge.classList.toggle('hidden', totalUnread === 0);
                    }
                    // --- END NEW ---
                });
                
                unreadListeners.main = unreadRoot;
            }


            // --- USER BLOCKING ---
            
            // Block user (e.g., from chatMoreBtn)
            chatMoreBtn.addEventListener('click', () => {
                if (!currentChatPartner) return;
                
                const isBlocked = currentUserData.blocked && currentUserData.blocked[currentChatPartner.uid];
                const actionText = isBlocked ? `Unblock ${currentChatPartner.name}` : `Block ${currentChatPartner.name}`;
                
                if (confirm(actionText + "?")) {
                    if (isBlocked) {
                        unblockUser(currentChatPartner.uid);
                    } else {
                        blockUser(currentChatPartner.uid);
                    }
                }
            });
            
            function blockUser(uid) {
                db.ref(`users/${currentUser.uid}/blocked/${uid}`).set(true)
                    .then(() => {
                        alert('User blocked.');
                        currentUserData.blocked = currentUserData.blocked || {};
                        currentUserData.blocked[uid] = true;
                        // Reload contacts and close chat
                        listenForContacts();
                        listenForAllFriends(); // Refresh "ALL FRIEND" list
                        showView('main-view');
                        // NEW: Manually go back in history to sync state
                        if (history.state) {
                            history.back();
                        }
                    });
            }

            function unblockUser(uid) {
                db.ref(`users/${currentUser.uid}/blocked/${uid}`).remove()
                    .then(() => {
                        alert('User unblocked.');
                        if (currentUserData.blocked) {
                            delete currentUserData.blocked[uid];
                        }
                        // Reload contacts and profile modal if open
                        listenForContacts();
                        listenForAllFriends(); // Refresh "ALL FRIEND" list
                        if (!profileViewModal.classList.contains('hidden')) {
                            menuBtn.click(); // Re-click to refresh modal
                        }
                    });
            }

            // --- WEBRTC CALLING LOGIC (KEPT BUT UNREACHABLE VIA UI BUTTONS) ---

            // --- 1. Start a Call (Unreachable due to button removal, kept for reference) ---
            /*
            videoCallBtn.addEventListener('click', () => startCall(true));
            voiceCallBtn.addEventListener('click', () => startCall(false));
            */

            async function startCall(isVideo) {
                if (!currentChatPartner) return;
                const partnerId = currentChatPartner.uid;

                try {
                    // Get local media
                    localStream = await navigator.mediaDevices.getUserMedia({
                        video: isVideo,
                        audio: true
                    });
                    localVideo.srcObject = localStream; // Show self-view

                    // Create Peer Connection
                    peerConnection = new RTCPeerConnection(rtcConfig);
                    addLocalTracksToPC();

                    // Create a unique call ID
                    const callRef = db.ref('calls').push();
                    activeCallId = callRef.key;

                    // Create Offer
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);

                    const callData = {
                        callId: activeCallId,
                        from: currentUser.uid,
                        to: partnerId,
                        offer: offer,
                        isVideo: isVideo,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    };

                    // Write call data to the 'calls' node *for the recipient*
                    await db.ref(`calls/${partnerId}/${activeCallId}`).set(callData);

                    // Listen for ICE candidates and add them to DB
                    listenForIceCandidates(activeCallId, 'caller', partnerId);
                    
                    // Listen for an answer from the callee
                    callRef.on('value', snapshot => {
                        const data = snapshot.val();
                        if (data && data.answer && peerConnection.signalingState !== 'stable') {
                            peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer))
                                .catch(e => console.error("Error setting remote description:", e));
                        }
                    });
                    
                    // Listen for callee's ICE candidates
                    listenForRemoteIceCandidates(activeCallId, 'callee');

                    // Show the correct call UI
                    setupCallUI(currentChatPartner, isVideo, 'Calling...');
                    showView(isVideo ? 'video-call-view' : 'voice-call-view');
                    // NEW: Push history state for call view
                    history.pushState(null, '', window.location.pathname);

                } catch (err) {
                    console.error('Error starting call:', err);
                    alert('Could not start call. Check camera/mic permissions.');
                    cleanupCall();
                }
            }

            // --- 2. Listen for Incoming Calls ---
            function listenForIncomingCalls() {
                if (callListener) callListener.off();
                callListener = db.ref('calls/' + currentUser.uid);

                callListener.on('child_added', snapshot => {
                    const call = snapshot.val();
                    
                    // Ignore if already in a call or if caller is blocked
                    if (activeCallId || (currentUserData.blocked && currentUserData.blocked[call.from])) {
                        // Automatically reject
                        db.ref(`calls/${currentUser.uid}/${snapshot.key}`).remove();
                        return;
                    }
                    
                    incomingCallData = call;
                    
                    // Get caller info
                    db.ref('users/' + call.from).once('value', userSnapshot => {
                        const caller = userSnapshot.val();
                        // MODIFIED: Use getProfilePicHTML
                        incomingCallPicWrapper.innerHTML = getProfilePicHTML(caller, '4.5rem');
                        incomingCallName.textContent = caller.name;
                        incomingCallType.textContent = `Incoming ${call.isVideo ? 'video' : 'voice'} call...`;
                        
                        showModal('incoming-call-modal');
                        // NEW: Push history state for incoming call modal
                        history.pushState(null, '', window.location.pathname);
                        ringtone.play();
                    });
                });
                
                // Listen for call removal (e.g., caller hung up)
                callListener.on('child_removed', snapshot => {
                    if (incomingCallData && incomingCallData.callId === snapshot.key) {
                        // Call was canceled or rejected
                        cleanupCall();
                        // NEW: Manually go back in history to sync state
                        if (history.state) {
                            history.back();
                        }
                    }
                });
            }

            // --- 3. Accept a Call ---
            acceptCallBtn.addEventListener('click', async () => {
                if (!incomingCallData) return;

                activeCallId = incomingCallData.callId;
                const isVideo = incomingCallData.isVideo;
                
                ringtone.pause();
                showModal('incoming-call-modal', false);
                // Note: We don't need history.back() here because the popstate
                // handler will already be handling the modal close.
                // We are navigating FORWARD to a call view.

                try {
                    // Get local media
                    localStream = await navigator.mediaDevices.getUserMedia({
                        video: isVideo,
                        audio: true
                    });
                    localVideo.srcObject = localStream;
                    
                    // Create Peer Connection
                    peerConnection = new RTCPeerConnection(rtcConfig);
                    addLocalTracksToPC();

                    // Set remote description (the offer)
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(incomingCallData.offer));
                    
                    // Create Answer
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);

                    // Send answer back to the caller
                    await db.ref(`calls/${incomingCallData.from}/${activeCallId}`).update({
                        answer: answer
                    });
                    
                    // Listen for ICE candidates
                    listenForIceCandidates(activeCallId, 'callee', incomingCallData.from);
                    
                    // Listen for caller's ICE candidates
                    listenForRemoteIceCandidates(activeCallId, 'caller');

                    // Show call UI
                    db.ref('users/' + incomingCallData.from).once('value', userSnapshot => {
                        setupCallUI(userSnapshot.val(), isVideo, 'Connected');
                        showView(isVideo ? 'video-call-view' : 'voice-call-view');
                        // NEW: Push history state for call view
                        // This replaces the modal state with the call state
                        history.pushState(null, '', window.location.pathname);
                    });
                    
                    // Log the call
                    logCall(incomingCallData.from, isVideo, 'answered');

                } catch (err) {
                    console.error('Error accepting call:', err);
                    cleanupCall();
                }
            });

            // --- 4. Reject a Call ---
            rejectCallBtn.addEventListener('click', () => {
                if (!incomingCallData) return;
                
                // Remove the call from the DB, signaling rejection
                db.ref(`calls/${currentUser.uid}/${incomingCallData.callId}`).remove();
                
                logCall(incomingCallData.from, incomingCallData.isVideo, 'rejected');
                cleanupCall(); // Cleans up modal, ringtone, etc.
                // NEW: Manually go back in history to sync state
                if (history.state) {
                    history.back();
                }
            });
            
            // --- 5. End a Call ---
            videoEndCallBtn.addEventListener('click', endCall);
            voiceEndCallBtn.addEventListener('click', endCall);

            function endCall() {
                if (!activeCallId) return cleanupCall();
                
                // Find who the other person was
                let otherUserId = null;
                if(incomingCallData) {
                    otherUserId = incomingCallData.from; // We received the call
                } else if (currentChatPartner) {
                    otherUserId = currentChatPartner.uid; // We started the call
                }
                
                // Remove call objects from DB
                if(otherUserId) {
                    db.ref(`calls/${otherUserId}/${activeCallId}`).remove();
                    db.ref(`calls/${currentUser.uid}/${activeCallId}`).remove();
                }
                db.ref(`iceCandidates/${activeCallId}`).remove();
                
                cleanupCall();
                // NEW: Manually go back in history to sync state
                if (history.state) {
                    history.back();
                }
            }

            // --- 6. WebRTC Helper Functions ---
            
            function addLocalTracksToPC() {
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // Handle remote track
                peerConnection.ontrack = event => {
                    remoteStream = event.streams[0];
                    if (remoteVideo.srcObject !== remoteStream) {
                        remoteVideo.srcObject = remoteStream;
                        remoteAudio.srcObject = remoteStream; // For voice-only calls
                    }
                };
                
                // Handle connection state changes
                peerConnection.onconnectionstatechange = () => {
                    if (peerConnection.connectionState === 'disconnected' ||
                        peerConnection.connectionState === 'failed' ||
                        peerConnection.connectionState === 'closed') {
                        endCall();
                    }
                    if (peerConnection.connectionState === 'connected') {
                        voiceCallStatus.textContent = 'Connected';
                    }
                };
            }
            
            function listenForIceCandidates(callId, role, otherUserId) {
                peerConnection.onicecandidate = event => {
                    if (event.candidate) {
                        // Send candidate to the other user via DB
                        db.ref(`iceCandidates/${callId}/${role}`).push(event.candidate.toJSON());
                        
                        // Also write to a node the other user is listening to (for faster signaling)
                        if(otherUserId) {
                            db.ref(`iceSignals/${otherUserId}/${callId}`).push(event.candidate.toJSON());
                        }
                    }
                };
            }

            function listenForRemoteIceCandidates(callId, remoteRole) {
                // Main listener on the shared `iceCandidates` node
                db.ref(`iceCandidates/${callId}/${remoteRole}`).on('child_added', snapshot => {
                    if (snapshot.exists() && peerConnection) {
                        peerConnection.addIceCandidate(new RTCSessionDescription(snapshot.val()))
                            .catch(e => console.error('Error adding ICE candidate:', e));
                    }
                });

                // Faster signaling listener
                db.ref(`iceSignals/${currentUser.uid}/${callId}`).on('child_added', snapshot => {
                    if (snapshot.exists() && peerConnection) {
                        peerConnection.addIceCandidate(new RTCSessionDescription(snapshot.val()))
                            .catch(e => console.error('Error adding ICE candidate (signal):', e));
                        // Remove after processing
                        snapshot.ref.remove();
                    }
                });
            }

            function setupCallUI(partner, isVideo, status) {
                // MODIFIED: Use getProfilePicHTML
                if (isVideo) {
                    videoCallerPicWrapper.innerHTML = getProfilePicHTML(partner, '4.5rem');
                    videoCallerName.textContent = partner.name;
                } else {
                    voiceCallerPicWrapper.innerHTML = getProfilePicHTML(partner, '4.5rem');
                    voiceCallerName.textContent = partner.name;
                    voiceCallStatus.textContent = status;
                }
            }

            function logCall(partnerId, isVideo, type) {
                // This is a simple log. A real app would log for both users.
                const callLog = {
                    partnerId: partnerId,
                    isVideo: isVideo,
                    type: type, // e.g., 'outgoing', 'answered', 'missed', 'rejected'
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };
                db.ref(`callLogs/${currentUser.uid}`).push(callLog);
                
                // Also log for the partner
                const partnerLog = { ...callLog, partnerId: currentUser.uid, type: type === 'answered' ? 'answered' : 'missed' };
                db.ref(`callLogs/${partnerId}`).push(partnerLog);
            }

        });
    </script>
</body>
</html>